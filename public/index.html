<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bemusterungstool - Digitale Ausstattungsbemusterung</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f172a;
            --primary-light: #1e293b;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --accent-dark: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        h1, h2, h3, h4 {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            line-height: 1.2;
            letter-spacing: -0.02em;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1.25rem 2rem;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            letter-spacing: -0.02em;
        }

        .logo-icon {
            height: 40px;
            width: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.9rem;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Login Screen */
        .login-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: linear-gradient(135deg, #f0f4f8 0%, #e8efe8 100%);
        }

        .login-box {
            background: var(--surface);
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 440px;
            border: 1px solid var(--border);
        }

        .login-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .login-subtitle {
            color: var(--text-muted);
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 58, 82, 0.1);
        }

        .btn-primary {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.875rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(26, 58, 82, 0.25);
        }

        .login-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--bg);
            padding: 0.25rem;
            border-radius: 8px;
        }

        .login-tab {
            flex: 1;
            padding: 0.625rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.9rem;
            font-family: 'Inter', sans-serif;
        }

        .login-tab.active {
            background: var(--surface);
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Dashboard */
        .dashboard-header {
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .dashboard-subtitle {
            color: var(--text-muted);
            font-size: 1.05rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-muted);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            position: relative;
            bottom: -2px;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--accent);
            font-weight: 600;
        }

        .tab:hover:not(.active) {
            color: var(--text);
            background: rgba(59, 130, 246, 0.05);
            border-radius: 8px 8px 0 0;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.9rem;
            font-family: 'Inter', sans-serif;
        }

        .btn:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-accent {
            background: var(--accent);
            color: var(--primary);
        }

        .btn-accent:hover {
            background: var(--accent-light);
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.85rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            text-align: left;
            padding: 0.875rem;
            background: var(--bg);
            font-weight: 600;
            color: var(--text);
            border-bottom: 2px solid var(--border);
            font-size: 0.9rem;
        }

        .table td {
            padding: 1rem 0.875rem;
            border-bottom: 1px solid var(--border);
        }

        .table tr:hover {
            background: var(--bg);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(5, 150, 105, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .badge-primary {
            background: rgba(26, 58, 82, 0.1);
            color: var(--primary);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--surface);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.75rem;
            color: var(--primary);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Wizard */
        .wizard-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .wizard-progress {
            margin-bottom: 3rem;
        }

        .wizard-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 1rem;
        }

        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border);
            z-index: 0;
        }

        .wizard-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            flex: 1;
        }

        .wizard-step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--surface);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
        }

        .wizard-step.active .wizard-step-number {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .wizard-step.completed .wizard-step-number {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .wizard-step-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-align: center;
        }

        .wizard-step.active .wizard-step-label {
            color: var(--primary);
            font-weight: 600;
        }

        .wizard-content {
            background: var(--surface);
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border);
        }

        .wizard-category-title {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .wizard-category-desc {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .option-card {
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--surface);
        }

        .option-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }

        .option-card.selected {
            border-color: var(--accent);
            background: rgba(212, 175, 55, 0.05);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
        }

        .option-image {
            width: 100%;
            height: 180px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 3rem;
        }

        .option-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .option-description {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .option-price {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
        }

        .wizard-summary {
            background: var(--bg);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .summary-item:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .wizard-actions {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
        }

        .price-display {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: var(--primary);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .price-label {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .price-amount {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
        }

        /* Completion */
        .completion-container {
            text-align: center;
            padding: 3rem;
        }

        .completion-icon {
            width: 80px;
            height: 80px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 1.5rem;
            animation: scaleIn 0.5s;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .completion-title {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .completion-message {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        .alert {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .alert-error {
            background: rgba(220, 38, 38, 0.1);
            color: var(--error);
            border: 1px solid rgba(220, 38, 38, 0.2);
        }

        /* Lightbox f√ºr Bildvergr√∂√üerung */
        .lightbox-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 2rem;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            animation: zoomIn 0.3s ease;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .lightbox-image {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .lightbox-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .option-image-clickable {
            cursor: zoom-in;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .option-image-clickable:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Inter', sans-serif;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .tabs {
                overflow-x: auto;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .wizard-actions {
                flex-direction: column;
            }

            .modal {
                width: 95%;
                padding: 1.5rem;
            }
        }

        /* Footer */
        .app-footer {
            background: var(--primary);
            color: rgba(255, 255, 255, 0.8);
            padding: 1.5rem 2rem;
            margin-top: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
        }

        .footer-link {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-link:hover {
            color: white;
            text-decoration: underline;
        }

        .footer-divider {
            color: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Initial demo data
        const initialData = {
            projects: [
                {
                    id: 1,
                    name: 'Wohnpark Sonnenh√∂he',
                    status: 'Aktiv',
                    startDate: '2024-01-15',
                    endDate: '2024-12-31',
                    logo: '', // Projekt-Logo (wird √ºberall angezeigt)
                    welcomeImage: '', // Begr√º√üungsbild (nur auf Welcome-Screen)
                    welcomeText: 'Herzlich willkommen zur Bemusterung Ihrer neuen Wohnung! Auf den folgenden Seiten k√∂nnen Sie Ihre pers√∂nlichen Ausstattungsw√ºnsche ausw√§hlen. Nehmen Sie sich Zeit und treffen Sie Ihre Auswahl in Ruhe.',
                    categories: [
                        {
                            id: 1,
                            name: 'Bodenbel√§ge',
                            description: 'W√§hlen Sie Ihren bevorzugten Bodenbelag',
                            options: [
                                { id: 1, name: 'Eiche Natur', description: 'Hochwertiges Parkettlaminat in nat√ºrlicher Eiche', price: 0, icon: 'ü™µ' },
                                { id: 2, name: 'Eiche Grau', description: 'Modernes graues Parkettlaminat', price: 850, icon: 'ü™µ' },
                                { id: 3, name: 'Fliesen Marmor-Optik', description: 'Elegante Fliesen in Marmoroptik', price: 1200, icon: '‚¨ú' }
                            ]
                        },
                        {
                            id: 2,
                            name: 'Sanit√§rausstattung',
                            description: 'W√§hlen Sie Ihre Sanit√§rausstattung',
                            options: [
                                { id: 4, name: 'Standard wei√ü', description: 'Klassische wei√üe Sanit√§robjekte', price: 0, icon: 'üöø' },
                                { id: 5, name: 'Premium grau', description: 'Hochwertige graue Sanit√§robjekte', price: 1500, icon: 'üöø' },
                                { id: 6, name: 'Designer schwarz-matt', description: 'Exklusive schwarze Designer-Sanit√§robjekte', price: 2800, icon: 'üöø' }
                            ]
                        },
                        {
                            id: 3,
                            name: 'Elektroinstallation',
                            description: 'W√§hlen Sie Ihre Elektroausstattung',
                            options: [
                                { id: 7, name: 'Standard', description: 'Basis-Elektroinstallation', price: 0, icon: 'üí°' },
                                { id: 8, name: 'Komfort', description: 'Erweiterte Elektroinstallation mit zus√§tzlichen Steckdosen', price: 680, icon: 'üí°' },
                                { id: 9, name: 'Smart Home', description: 'Vollst√§ndige Smart-Home-Integration', price: 3200, icon: 'üè†' }
                            ]
                        }
                    ]
                }
            ],
            apartments: [
                { id: 1, projectId: 1, number: 'A-01', floor: 1, size: 65, status: 'Bemusterung offen', customOptions: {} },
                { id: 2, projectId: 1, number: 'A-02', floor: 1, size: 78, status: 'Abgeschlossen', customOptions: {} },
                { id: 3, projectId: 1, number: 'B-01', floor: 2, size: 92, status: 'Bemusterung offen', customOptions: {} }
            ],
            customerAccess: [
                { id: 1, apartmentId: 1, code: 'DEMO123', customerName: 'Familie Mustermann' }
            ],
            selections: []
        };

        // App Component
        function App() {
            const [user, setUser] = useState(null);
            const [data, setData] = useState(() => {
                const saved = localStorage.getItem('bemusterungstool_data');
                return saved ? JSON.parse(saved) : initialData;
            });

            useEffect(() => {
                localStorage.setItem('bemusterungstool_data', JSON.stringify(data));
            }, [data]);

            const handleLogin = (loginData) => {
                setUser(loginData);
            };

            const handleLogout = () => {
                setUser(null);
            };

            if (!user) {
                return <LoginScreen onLogin={handleLogin} data={data} />;
            }

            if (user.role === 'admin') {
                return <AdminDashboard user={user} data={data} setData={setData} onLogout={handleLogout} />;
            }

            return <CustomerWizard user={user} data={data} setData={setData} onLogout={handleLogout} />;
        }

        // Login Screen
        function LoginScreen({ onLogin, data }) {
            const [accessCode, setAccessCode] = useState('');
            const [error, setError] = useState('');
            const [adminClicks, setAdminClicks] = useState(0);

            const handleCustomerLogin = (e) => {
                e.preventDefault();
                const access = data.customerAccess.find(a => a.code === accessCode.toUpperCase());
                if (access) {
                    const apartment = data.apartments.find(a => a.id === access.apartmentId);
                    onLogin({ role: 'customer', accessId: access.id, apartmentId: access.apartmentId, apartment });
                } else {
                    setError('Ung√ºltiger Zugangscode');
                }
            };

            const handleLogoClick = () => {
                setAdminClicks(prev => prev + 1);
                if (adminClicks >= 4) {
                    const username = prompt('Benutzername:');
                    const password = prompt('Passwort:');
                    if (username === 'admin' && password === 'admin') {
                        onLogin({ role: 'admin', username: 'admin' });
                    } else {
                        alert('Ung√ºltige Zugangsdaten');
                    }
                    setAdminClicks(0);
                }
            };

            return (
                <div className="app-container">
                    <div className="header">
                        <div className="header-content">
                            <div className="logo" onClick={handleLogoClick} style={{ cursor: 'pointer' }}>
                                <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAgEAyADIAAD/4gxYSUNDX1BST0ZJTEUAAQEAAAxITGlubwIQAABtbnRyUkdCIFhZWiAHzgACAAkABgAxAABhY3NwTVNGVAAAAABJRUMgc1JHQgAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLUhQICAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFjcHJ0AAABUAAAADNkZXNjAAABhAAAAGx3dHB0AAAB8AAAABRia3B0AAACBAAAABRyWFlaAAACGAAAABRnWFlaAAACLAAAABRiWFlaAAACQAAAABRkbW5kAAACVAAAAHBkbWRkAAACxAAAAIh2dWVkAAADTAAAAIZ2aWV3AAAD1AAAACRsdW1pAAAD+AAAABRtZWFzAAAEDAAAACR0ZWNoAAAEMAAAAAxyVFJDAAAEPAAACAxnVFJDAAAEPAAACAxiVFJDAAAEPAAACAx0ZXh0AAAAAENvcHlyaWdodCAoYykgMTk5OCBIZXdsZXR0LVBhY2thcmQgQ29tcGFueQAAZGVzYwAAAAAAAAASc1JHQiBJRUM2MTk2Ni0yLjEAAAAAAAAAAAAAABJzUkdCIElFQzYxOTY2LTIuMQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWFlaIAAAAAAAAPNRAAEAAAABFsxYWVogAAAAAAAAAAAAAAAAAAAAAFhZWiAAAAAAAABvogAAOPUAAAOQWFlaIAAAAAAAAGKZAAC3hQAAGNpYWVogAAAAAAAAJKAAAA+EAAC2z2Rlc2MAAAAAAAAAFklFQyBodHRwOi8vd3d3LmllYy5jaAAAAAAAAAAAAAAWC" className="logo-icon" alt="G+S Gruppe" />
                                <span style={{ fontSize: '0.9rem' }}>Bemusterungstool</span>
                            </div>
                        </div>
                    </div>
                    <div className="login-container">
                        <div className="login-box">
                            <h1 className="login-title">Ihre Bemusterung</h1>
                            <p className="login-subtitle">Geben Sie Ihren pers√∂nlichen Zugangscode ein</p>

                            {error && (
                                <div className="alert alert-error">
                                    ‚ö†Ô∏è {error}
                                </div>
                            )}

                            <form onSubmit={handleCustomerLogin}>
                                <div className="form-group">
                                    <label className="form-label">Zugangscode</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={accessCode}
                                        onChange={(e) => setAccessCode(e.target.value)}
                                        placeholder="z.B. DEMO123"
                                        style={{ textTransform: 'uppercase' }}
                                    />
                                </div>
                                <button type="submit" className="btn-primary">Zur Bemusterung</button>
                                <p style={{ marginTop: '1rem', fontSize: '0.85rem', color: 'var(--text-muted)', textAlign: 'center' }}>
                                    Sie haben Ihren Zugangscode per E-Mail erhalten
                                </p>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // Admin Dashboard
        function AdminDashboard({ user, data, setData, onLogout }) {
            const [activeTab, setActiveTab] = useState('overview');
            const [showProjectModal, setShowProjectModal] = useState(false);
            const [showApartmentModal, setShowApartmentModal] = useState(false);
            const [showAccessModal, setShowAccessModal] = useState(false);

            const handleExport = () => {
                const selections = data.selections;
                let csv = 'Wohnung,Kategorie,Option,Mehrpreis\n';
                selections.forEach(sel => {
                    const apartment = data.apartments.find(a => a.id === sel.apartmentId);
                    Object.entries(sel.choices).forEach(([catId, optId]) => {
                        const project = data.projects.find(p => p.id === apartment.projectId);
                        const category = project.categories.find(c => c.id === parseInt(catId));
                        const option = category.options.find(o => o.id === optId);
                        csv += `${apartment.number},${category.name},${option.name},${option.price}‚Ç¨\n`;
                    });
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bemusterungen.csv';
                a.click();
            };

            const handleGeneratePDF = (apartment, project, selections, totalPrice, status = 'Abgeschlossen') => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header with gray design
                doc.setFillColor(107, 114, 128);
                doc.rect(0, 0, 210, 45, 'F');
                
                // G+S Logo area (placeholder)
                doc.setFillColor(255, 255, 255);
                doc.rect(15, 10, 25, 25, 'F');
                doc.setFontSize(16);
                doc.setTextColor(107, 114, 128);
                doc.setFont('helvetica', 'bold');
                doc.text('G+S', 20, 26);
                
                // Title
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('Bemusterungsbest√§tigung', 50, 28);

                // Project & Apartment Info
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`Projekt: ${project.name}`, 20, 60);
                doc.text(`Wohnung: ${apartment.number}`, 20, 67);
                doc.text(`Gr√∂√üe: ${apartment.size} m¬≤`, 20, 74);
                doc.text(`Datum: ${new Date().toLocaleDateString('de-DE')}`, 150, 67);

                // Status badge
                const statusText = status === 'Abgeschlossen' ? 'ABGESCHLOSSEN' : 'VORL√ÑUFIG';
                const statusColor = status === 'Abgeschlossen' ? [5, 150, 105] : [245, 158, 11]; // Green or Orange
                doc.setFillColor(...statusColor);
                doc.roundedRect(150, 72, 40, 8, 2, 2, 'F');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text(statusText, 170, 77.5, { align: 'center' });

                // Line separator
                doc.setDrawColor(107, 114, 128);
                doc.setLineWidth(0.5);
                doc.line(20, 85, 190, 85);

                // Selections
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Ihre Auswahl:', 20, 95);
                
                let yPos = 105;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');

                Object.entries(selections).forEach(([catId, optId]) => {
                    const category = project.categories.find(c => c.id === parseInt(catId));
                    const option = category?.options.find(o => o.id === optId);
                    
                    if (category && option) {
                        // Category background
                        doc.setFillColor(250, 250, 250);
                        doc.rect(20, yPos - 5, 170, 16, 'F');
                        
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text(category.name, 25, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(60, 60, 60);
                        doc.text(option.name, 25, yPos + 7);
                        
                        // Price
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(107, 114, 128);
                        const priceText = option.price === 0 ? 'Inkl.' : `+ ${option.price.toLocaleString('de-DE')} ‚Ç¨`;
                        doc.text(priceText, 185, yPos + 3, { align: 'right' });
                        
                        yPos += 20;
                    }
                });

                // Total box
                yPos += 5;
                doc.setFillColor(107, 114, 128);
                doc.rect(20, yPos, 170, 18, 'F');
                doc.setFontSize(13);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('Gesamte Mehrkosten:', 25, yPos + 11);
                doc.text(`${totalPrice.toLocaleString('de-DE')} ‚Ç¨`, 185, yPos + 11, { align: 'right' });

                // Footer - different text based on status
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(107, 114, 128);
                
                if (status === 'Abgeschlossen') {
                    doc.text('Diese Auswahl ist verbindlich und kann nicht mehr ge√§ndert werden.', 20, 280);
                } else {
                    doc.text('VORL√ÑUFIGE AUSWAHL - Diese Bemusterung ist noch nicht verbindlich best√§tigt.', 20, 280);
                    doc.text('Der Kunde kann seine Auswahl noch √§ndern.', 20, 285);
                }
                doc.text('G+S Gruppe ‚Ä¢ Projektentwicklung seit √ºber 60 Jahren ‚Ä¢ www.g-s-wohnbau.de', 20, 290);

                // Download
                const statusSuffix = status === 'Abgeschlossen' ? 'Final' : 'Entwurf';
                doc.save(`Bemusterung_${apartment.number}_${statusSuffix}_${new Date().toLocaleDateString('de-DE').replace(/\./g, '-')}.pdf`);
            };

            const handleCreateProject = (projectData) => {
                const newProject = {
                    id: Date.now(),
                    ...projectData,
                    welcomeText: projectData.welcomeText || 'Willkommen zur Bemusterung!',
                    categories: []
                };
                setData({ ...data, projects: [...data.projects, newProject] });
                setShowProjectModal(false);
            };

            const handleDeleteProject = (projectId) => {
                if (confirm('M√∂chten Sie dieses Projekt wirklich l√∂schen? Alle zugeh√∂rigen Daten werden gel√∂scht.')) {
                    setData({
                        ...data,
                        projects: data.projects.filter(p => p.id !== projectId),
                        apartments: data.apartments.filter(a => a.projectId !== projectId)
                    });
                }
            };

            const handleArchiveProject = (projectId) => {
                setData({
                    ...data,
                    projects: data.projects.map(p =>
                        p.id === projectId ? { ...p, status: p.status === 'Archiviert' ? 'Aktiv' : 'Archiviert' } : p
                    )
                });
            };

            const handleCreateApartment = (apartmentData) => {
                // Check if it's an array (bulk creation) or single apartment
                if (Array.isArray(apartmentData)) {
                    // Bulk creation
                    const newApartments = apartmentData.map((apt, index) => ({
                        id: Date.now() + index,
                        ...apt,
                        status: 'Bemusterung offen'
                    }));
                    setData({ ...data, apartments: [...data.apartments, ...newApartments] });
                } else {
                    // Single creation
                    const newApartment = {
                        id: Date.now(),
                        ...apartmentData,
                        status: 'Bemusterung offen'
                    };
                    setData({ ...data, apartments: [...data.apartments, newApartment] });
                }
                setShowApartmentModal(false);
            };

            const handleDeleteApartment = (apartmentId) => {
                if (confirm('M√∂chten Sie diese Wohnung wirklich l√∂schen?')) {
                    setData({
                        ...data,
                        apartments: data.apartments.filter(a => a.id !== apartmentId),
                        selections: data.selections.filter(s => s.apartmentId !== apartmentId)
                    });
                }
            };

            const handleCreateAccess = (accessData) => {
                const newAccess = {
                    id: Date.now(),
                    ...accessData,
                    code: generateAccessCode()
                };
                setData({ ...data, customerAccess: [...data.customerAccess, newAccess] });
                setShowAccessModal(false);
            };

            const generateAccessCode = () => {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            };

            const stats = {
                totalProjects: data.projects.length,
                totalApartments: data.apartments.length,
                completedSampling: data.selections.length,
                openSampling: data.apartments.length - data.selections.length
            };

            return (
                <div className="app-container">
                    <div className="header">
                        <div className="header-content">
                            <div className="logo">
                                <div className="logo-icon">B</div>
                                Bemusterungstool
                            </div>
                            <div className="user-info">
                                <span>Administrator: {user.username}</span>
                                <button className="btn-logout" onClick={onLogout}>Abmelden</button>
                            </div>
                        </div>
                    </div>

                    <div className="main-content">
                        <div className="dashboard-header">
                            <h1 className="dashboard-title">Dashboard</h1>
                            <p className="dashboard-subtitle">Verwalten Sie Ihre Projekte und Bemusterungen</p>
                        </div>

                        {activeTab === 'overview' && (
                            <>
                                <div className="grid">
                                    <div className="stat-card">
                                        <div className="stat-value">{stats.totalProjects}</div>
                                        <div className="stat-label">Aktive Projekte</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-value">{stats.totalApartments}</div>
                                        <div className="stat-label">Wohnungen gesamt</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-value">{stats.completedSampling}</div>
                                        <div className="stat-label">Bemusterungen abgeschlossen</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-value">{stats.openSampling}</div>
                                        <div className="stat-label">Bemusterungen offen</div>
                                    </div>
                                </div>

                                <div className="card">
                                    <div className="card-header">
                                        <h2 className="card-title">Schnellaktionen</h2>
                                    </div>
                                    <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                                        <button className="btn" onClick={() => setActiveTab('projects')}>Neues Projekt anlegen</button>
                                        <button className="btn btn-secondary" onClick={() => setActiveTab('apartments')}>Wohnung hinzuf√ºgen</button>
                                        <button className="btn btn-accent" onClick={handleExport}>Daten exportieren</button>
                                    </div>
                                </div>
                            </>
                        )}

                        <div className="tabs">
                            <button className={`tab ${activeTab === 'overview' ? 'active' : ''}`} onClick={() => setActiveTab('overview')}>√úbersicht</button>
                            <button className={`tab ${activeTab === 'projects' ? 'active' : ''}`} onClick={() => setActiveTab('projects')}>Projekte</button>
                            <button className={`tab ${activeTab === 'apartments' ? 'active' : ''}`} onClick={() => setActiveTab('apartments')}>Wohnungen</button>
                            <button className={`tab ${activeTab === 'access' ? 'active' : ''}`} onClick={() => setActiveTab('access')}>Kundenzug√§nge</button>
                            <button className={`tab ${activeTab === 'selections' ? 'active' : ''}`} onClick={() => setActiveTab('selections')}>Bemusterungen</button>
                        </div>

                        {activeTab === 'projects' && (
                            <ProjectsView
                                data={data}
                                setData={setData}
                                onShowProjectModal={() => setShowProjectModal(true)}
                            />
                        )}

                        {activeTab === 'apartments' && (
                            <ApartmentsView
                                data={data}
                                setData={setData}
                                onShowApartmentModal={() => setShowApartmentModal(true)}
                                onDeleteApartment={handleDeleteApartment}
                            />
                        )}

                        {activeTab === 'access' && (
                            <AccessView data={data} setData={setData} onShowAccessModal={() => setShowAccessModal(true)} />
                        )}

                        {activeTab === 'selections' && (
                            <SelectionsView data={data} setData={setData} handleGeneratePDF={handleGeneratePDF} handleExport={handleExport} />
                        )}
                    </div>

                    {showProjectModal && (
                        <ProjectModal
                            onClose={() => setShowProjectModal(false)}
                            onSave={handleCreateProject}
                        />
                    )}

                    {showApartmentModal && (
                        <ApartmentModal
                            projects={data.projects}
                            onClose={() => setShowApartmentModal(false)}
                            onSave={handleCreateApartment}
                        />
                    )}

                    {showAccessModal && (
                        <AccessModal
                            apartments={data.apartments.filter(apt => {
                                const project = data.projects.find(p => p.id === apt.projectId);
                                return project && project.status !== 'Archiviert';
                            })}
                            existingAccess={data.customerAccess}
                            onClose={() => setShowAccessModal(false)}
                            onSave={handleCreateAccess}
                        />
                    )}
                </div>
            );
        }

        // Project Modal Component
        function ProjectModal({ onClose, onSave }) {
            const [formData, setFormData] = useState({
                name: '',
                status: 'Aktiv',
                startDate: '',
                endDate: '',
                logo: '',
                welcomeImage: '',
                welcomeText: 'Herzlich willkommen zur Bemusterung Ihrer neuen Wohnung! Auf den folgenden Seiten k√∂nnen Sie Ihre pers√∂nlichen Ausstattungsw√ºnsche ausw√§hlen. Nehmen Sie sich Zeit und treffen Sie Ihre Auswahl in Ruhe.'
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Neues Projekt anlegen</h2>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Projektname *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.name}
                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Status</label>
                                <select
                                    className="form-input"
                                    value={formData.status}
                                    onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                                >
                                    <option value="Aktiv">Aktiv</option>
                                    <option value="Inaktiv">Inaktiv</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Startdatum (optional)</label>
                                <input
                                    type="date"
                                    className="form-input"
                                    value={formData.startDate}
                                    onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Enddatum (optional)</label>
                                <input
                                    type="date"
                                    className="form-input"
                                    value={formData.endDate}
                                    onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Begr√º√üungstext f√ºr Kunden</label>
                                <textarea
                                    className="form-input"
                                    value={formData.welcomeText}
                                    onChange={(e) => setFormData({ ...formData, welcomeText: e.target.value })}
                                    rows="4"
                                    placeholder="Dieser Text wird dem Kunden vor der Bemusterung angezeigt"
                                />
                                <small style={{ color: 'var(--text-muted)', fontSize: '0.85rem' }}>
                                    Begr√º√üen Sie Ihre Kunden und erkl√§ren Sie den Bemusterungsprozess
                                </small>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Projekt-Logo (optional)</label>
                                <input
                                    type="file"
                                    className="form-input"
                                    accept="image/*"
                                    onChange={(e) => {
                                        const file = e.target.files[0];
                                        if (file) {
                                            const reader = new FileReader();
                                            reader.onloadend = () => {
                                                setFormData({ ...formData, logo: reader.result });
                                            };
                                            reader.readAsDataURL(file);
                                        }
                                    }}
                                />
                                {formData.logo && (
                                    <img 
                                        src={formData.logo} 
                                        alt="Logo Vorschau" 
                                        style={{ marginTop: '0.5rem', maxHeight: '60px' }}
                                    />
                                )}
                                <small style={{ color: 'var(--text-muted)', fontSize: '0.85rem' }}>
                                    Wird im Header auf allen Seiten des Kunden angezeigt
                                </small>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Begr√º√üungsbild (optional)</label>
                                <input
                                    type="file"
                                    className="form-input"
                                    accept="image/*"
                                    onChange={(e) => {
                                        const file = e.target.files[0];
                                        if (file) {
                                            const reader = new FileReader();
                                            reader.onloadend = () => {
                                                setFormData({ ...formData, welcomeImage: reader.result });
                                            };
                                            reader.readAsDataURL(file);
                                        }
                                    }}
                                />
                                {formData.welcomeImage && (
                                    <img 
                                        src={formData.welcomeImage} 
                                        alt="Bild Vorschau" 
                                        style={{ marginTop: '0.5rem', maxWidth: '200px', borderRadius: '8px' }}
                                    />
                                )}
                                <small style={{ color: 'var(--text-muted)', fontSize: '0.85rem' }}>
                                    Wird auf der Willkommensseite angezeigt (empfohlen: Geb√§udeansicht)
                                </small>
                            </div>
                            <div className="modal-actions">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>
                                    Abbrechen
                                </button>
                                <button type="submit" className="btn">
                                    Projekt erstellen
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Apartment Modal Component
        function ApartmentModal({ projects, onClose, onSave }) {
            const activeProjects = projects.filter(p => p.status !== 'Archiviert');
            const [isBulkMode, setIsBulkMode] = useState(false);
            const [formData, setFormData] = useState({
                projectId: activeProjects[0]?.id || '',
                number: '',
                floor: '',
                size: ''
            });
            const [bulkFormData, setBulkFormData] = useState({
                projectId: activeProjects[0]?.id || '',
                prefix: 'A',
                startNumber: 1,
                endNumber: 10,
                floor: '',
                size: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({
                    ...formData,
                    projectId: parseInt(formData.projectId),
                    floor: parseInt(formData.floor),
                    size: parseInt(formData.size)
                });
            };

            const handleBulkSubmit = (e) => {
                e.preventDefault();
                const apartments = [];
                for (let i = bulkFormData.startNumber; i <= bulkFormData.endNumber; i++) {
                    apartments.push({
                        projectId: parseInt(bulkFormData.projectId),
                        number: `${bulkFormData.prefix}-${String(i).padStart(2, '0')}`,
                        floor: parseInt(bulkFormData.floor),
                        size: parseInt(bulkFormData.size)
                    });
                }
                onSave(apartments);
            };

            if (activeProjects.length === 0) {
                return (
                    <div className="modal-overlay" onClick={onClose}>
                        <div className="modal" onClick={(e) => e.stopPropagation()}>
                            <div className="modal-header">
                                <h2 className="modal-title">Keine aktiven Projekte</h2>
                            </div>
                            <p>Es sind keine aktiven Projekte verf√ºgbar. Bitte aktivieren Sie ein Projekt oder erstellen Sie ein neues.</p>
                            <div className="modal-actions">
                                <button type="button" className="btn" onClick={onClose}>Schlie√üen</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">{isBulkMode ? 'Wohnungen im Stapel anlegen' : 'Neue Wohnung anlegen'}</h2>
                        </div>

                        <div style={{ marginBottom: '1.5rem', display: 'flex', gap: '0.5rem' }}>
                            <button
                                type="button"
                                className={`btn btn-small ${!isBulkMode ? '' : 'btn-secondary'}`}
                                onClick={() => setIsBulkMode(false)}
                            >
                                Einzeln
                            </button>
                            <button
                                type="button"
                                className={`btn btn-small ${isBulkMode ? '' : 'btn-secondary'}`}
                                onClick={() => setIsBulkMode(true)}
                            >
                                Stapelverarbeitung
                            </button>
                        </div>

                        {!isBulkMode ? (
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Projekt *</label>
                                <select
                                    className="form-input"
                                    value={formData.projectId}
                                    onChange={(e) => setFormData({ ...formData, projectId: e.target.value })}
                                    required
                                >
                                    {activeProjects.map(project => (
                                        <option key={project.id} value={project.id}>
                                            {project.name}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Wohnungsnummer *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="z.B. A-01"
                                    value={formData.number}
                                    onChange={(e) => setFormData({ ...formData, number: e.target.value })}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Etage *</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    placeholder="z.B. 1"
                                    value={formData.floor}
                                    onChange={(e) => setFormData({ ...formData, floor: e.target.value })}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Gr√∂√üe (m¬≤) *</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    placeholder="z.B. 65"
                                    value={formData.size}
                                    onChange={(e) => setFormData({ ...formData, size: e.target.value })}
                                    required
                                />
                            </div>
                            <div className="modal-actions">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>
                                    Abbrechen
                                </button>
                                <button type="submit" className="btn">
                                    Wohnung erstellen
                                </button>
                            </div>
                        </form>
                        ) : (
                        <form onSubmit={handleBulkSubmit}>
                            <div className="form-group">
                                <label className="form-label">Projekt *</label>
                                <select
                                    className="form-input"
                                    value={bulkFormData.projectId}
                                    onChange={(e) => setBulkFormData({ ...bulkFormData, projectId: e.target.value })}
                                    required
                                >
                                    {activeProjects.map(project => (
                                        <option key={project.id} value={project.id}>
                                            {project.name}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '1rem' }}>
                                <div className="form-group">
                                    <label className="form-label">Prefix *</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        placeholder="A"
                                        value={bulkFormData.prefix}
                                        onChange={(e) => setBulkFormData({ ...bulkFormData, prefix: e.target.value.toUpperCase() })}
                                        required
                                        maxLength="3"
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Von Nr. *</label>
                                    <input
                                        type="number"
                                        className="form-input"
                                        placeholder="1"
                                        value={bulkFormData.startNumber}
                                        onChange={(e) => setBulkFormData({ ...bulkFormData, startNumber: parseInt(e.target.value) })}
                                        required
                                        min="1"
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Bis Nr. *</label>
                                    <input
                                        type="number"
                                        className="form-input"
                                        placeholder="10"
                                        value={bulkFormData.endNumber}
                                        onChange={(e) => setBulkFormData({ ...bulkFormData, endNumber: parseInt(e.target.value) })}
                                        required
                                        min="1"
                                    />
                                </div>
                            </div>
                            <div className="alert" style={{ background: 'rgba(107, 114, 128, 0.1)', color: 'var(--text)', border: '1px solid var(--border)' }}>
                                ‚ÑπÔ∏è Es werden {Math.max(0, bulkFormData.endNumber - bulkFormData.startNumber + 1)} Wohnungen erstellt: {bulkFormData.prefix}-{String(bulkFormData.startNumber).padStart(2, '0')} bis {bulkFormData.prefix}-{String(bulkFormData.endNumber).padStart(2, '0')}
                            </div>
                            <div className="form-group">
                                <label className="form-label">Etage (f√ºr alle) *</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    placeholder="z.B. 1"
                                    value={bulkFormData.floor}
                                    onChange={(e) => setBulkFormData({ ...bulkFormData, floor: e.target.value })}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Gr√∂√üe in m¬≤ (f√ºr alle) *</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    placeholder="z.B. 65"
                                    value={bulkFormData.size}
                                    onChange={(e) => setBulkFormData({ ...bulkFormData, size: e.target.value })}
                                    required
                                />
                            </div>
                            <div className="modal-actions">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>
                                    Abbrechen
                                </button>
                                <button type="submit" className="btn">
                                    {Math.max(0, bulkFormData.endNumber - bulkFormData.startNumber + 1)} Wohnungen erstellen
                                </button>
                            </div>
                        </form>
                        )}
                    </div>
                </div>
            );
        }

        // Apartments View Component
        function ApartmentsView({ data, setData, onShowApartmentModal, onDeleteApartment }) {
            const [selectedApartment, setSelectedApartment] = useState(null);
            const [activeTab, setActiveTab] = useState('visibility'); // 'visibility' or 'custom'
            const [showCustomOptionModal, setShowCustomOptionModal] = useState(false);
            const [selectedCategory, setSelectedCategory] = useState(null);

            const handleToggleOption = (categoryId, optionId) => {
                const updatedApartments = data.apartments.map(apt => {
                    if (apt.id === selectedApartment.id) {
                        const hiddenOptions = { ...apt.hiddenOptions } || {};
                        if (!hiddenOptions[categoryId]) {
                            hiddenOptions[categoryId] = [];
                        }
                        
                        const index = hiddenOptions[categoryId].indexOf(optionId);
                        if (index > -1) {
                            // Remove from hidden (make visible)
                            hiddenOptions[categoryId] = hiddenOptions[categoryId].filter(id => id !== optionId);
                        } else {
                            // Add to hidden
                            hiddenOptions[categoryId].push(optionId);
                        }
                        
                        return { ...apt, hiddenOptions };
                    }
                    return apt;
                });
                
                setData({ ...data, apartments: updatedApartments });
                setSelectedApartment(updatedApartments.find(a => a.id === selectedApartment.id));
            };

            const handleAddCustomOption = (categoryId, optionData) => {
                const updatedApartments = data.apartments.map(apt => {
                    if (apt.id === selectedApartment.id) {
                        const customOptions = { ...apt.customOptions } || {};
                        if (!customOptions[categoryId]) {
                            customOptions[categoryId] = [];
                        }
                        
                        customOptions[categoryId].push({
                            id: Date.now(),
                            ...optionData,
                            isCustom: true
                        });
                        
                        return { ...apt, customOptions };
                    }
                    return apt;
                });
                
                setData({ ...data, apartments: updatedApartments });
                setSelectedApartment(updatedApartments.find(a => a.id === selectedApartment.id));
                setShowCustomOptionModal(false);
                setSelectedCategory(null);
            };

            const handleDeleteCustomOption = (categoryId, optionId) => {
                if (confirm('M√∂chten Sie diese wohnungsspezifische Option wirklich l√∂schen?')) {
                    const updatedApartments = data.apartments.map(apt => {
                        if (apt.id === selectedApartment.id) {
                            const customOptions = { ...apt.customOptions };
                            if (customOptions[categoryId]) {
                                customOptions[categoryId] = customOptions[categoryId].filter(opt => opt.id !== optionId);
                            }
                            return { ...apt, customOptions };
                        }
                        return apt;
                    });
                    
                    setData({ ...data, apartments: updatedApartments });
                    setSelectedApartment(updatedApartments.find(a => a.id === selectedApartment.id));
                }
            };

            if (selectedApartment) {
                const project = data.projects.find(p => p.id === selectedApartment.projectId);
                
                return (
                    <div className="card">
                        <div className="card-header">
                            <div>
                                <h2 className="card-title">Wohnung {selectedApartment.number}</h2>
                                <p style={{ color: 'var(--text-muted)', fontSize: '0.9rem', marginTop: '0.25rem' }}>
                                    {project?.name} ‚Ä¢ {selectedApartment.floor}. OG ‚Ä¢ {selectedApartment.size} m¬≤
                                </p>
                            </div>
                            <button className="btn btn-secondary" onClick={() => setSelectedApartment(null)}>
                                ‚Üê Zur√ºck zur √úbersicht
                            </button>
                        </div>

                        <div style={{ padding: '1rem 0' }}>
                            {/* Tabs */}
                            <div className="tabs" style={{ marginBottom: '2rem' }}>
                                <button 
                                    className={`tab ${activeTab === 'visibility' ? 'active' : ''}`} 
                                    onClick={() => setActiveTab('visibility')}
                                >
                                    Sichtbarkeit anpassen
                                </button>
                                <button 
                                    className={`tab ${activeTab === 'custom' ? 'active' : ''}`} 
                                    onClick={() => setActiveTab('custom')}
                                >
                                    Wohnungsspezifische Optionen
                                </button>
                            </div>

                            {activeTab === 'visibility' && (
                                <>
                                    <h3 style={{ fontSize: '1.25rem', color: 'var(--primary)', marginBottom: '1rem' }}>
                                        Verf√ºgbare Ausstattungsoptionen
                                    </h3>
                                    <p style={{ color: 'var(--text-muted)', fontSize: '0.9rem', marginBottom: '2rem' }}>
                                        Legen Sie fest, welche Optionen dem Kunden f√ºr diese Wohnung angezeigt werden sollen.
                                    </p>
                                </>
                            )}

                            {activeTab === 'custom' && (
                                <>
                                    <h3 style={{ fontSize: '1.25rem', color: 'var(--primary)', marginBottom: '1rem' }}>
                                        Zus√§tzliche Optionen nur f√ºr diese Wohnung
                                    </h3>
                                    <p style={{ color: 'var(--text-muted)', fontSize: '0.9rem', marginBottom: '2rem' }}>
                                        F√ºgen Sie spezielle Optionen hinzu, die nur f√ºr diese Wohnung verf√ºgbar sind (z.B. Premium-Ausstattung f√ºr Penthouse).
                                    </p>
                                </>
                            )}

                            {!project || project.categories.length === 0 ? (
                                <div style={{ textAlign: 'center', padding: '3rem', color: 'var(--text-muted)' }}>
                                    <p>F√ºr dieses Projekt sind noch keine Kategorien angelegt.</p>
                                    <p style={{ fontSize: '0.9rem', marginTop: '0.5rem' }}>
                                        Wechseln Sie zum Projekte-Tab, um Kategorien hinzuzuf√ºgen.
                                    </p>
                                </div>
                            ) : activeTab === 'visibility' ? (
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '2rem' }}>
                                    {project.categories.map(category => (
                                        <div key={category.id} style={{ background: 'var(--bg)', padding: '1.5rem', borderRadius: '8px', border: '1px solid var(--border)' }}>
                                            <h4 style={{ fontSize: '1.1rem', marginBottom: '0.5rem', color: 'var(--primary)' }}>
                                                {category.name}
                                            </h4>
                                            <p style={{ color: 'var(--text-muted)', fontSize: '0.9rem', marginBottom: '1.5rem' }}>
                                                {category.description}
                                            </p>

                                            {category.options.length === 0 ? (
                                                <p style={{ color: 'var(--text-muted)', fontSize: '0.85rem', fontStyle: 'italic' }}>
                                                    Keine Optionen vorhanden
                                                </p>
                                            ) : (
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                                    {category.options.map(option => {
                                                        const isHidden = selectedApartment.hiddenOptions?.[category.id]?.includes(option.id);
                                                        
                                                        return (
                                                            <div
                                                                key={option.id}
                                                                style={{
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    gap: '1rem',
                                                                    padding: '1rem',
                                                                    background: 'var(--surface)',
                                                                    borderRadius: '8px',
                                                                    border: '1px solid var(--border)',
                                                                    opacity: isHidden ? 0.5 : 1
                                                                }}
                                                            >
                                                                <input
                                                                    type="checkbox"
                                                                    checked={!isHidden}
                                                                    onChange={() => handleToggleOption(category.id, option.id)}
                                                                    style={{
                                                                        width: '20px',
                                                                        height: '20px',
                                                                        cursor: 'pointer',
                                                                        accentColor: 'var(--primary)'
                                                                    }}
                                                                />
                                                                {option.image ? (
                                                                    <img
                                                                        src={option.image}
                                                                        alt={option.name}
                                                                        style={{
                                                                            width: '60px',
                                                                            height: '60px',
                                                                            objectFit: 'cover',
                                                                            borderRadius: '6px'
                                                                        }}
                                                                    />
                                                                ) : (
                                                                    <div style={{
                                                                        width: '60px',
                                                                        height: '60px',
                                                                        display: 'flex',
                                                                        alignItems: 'center',
                                                                        justifyContent: 'center',
                                                                        background: 'var(--bg)',
                                                                        borderRadius: '6px',
                                                                        fontSize: '2rem'
                                                                    }}>
                                                                        {option.icon}
                                                                    </div>
                                                                )}
                                                                <div style={{ flex: 1 }}>
                                                                    <div style={{ fontWeight: 600, marginBottom: '0.25rem' }}>
                                                                        {option.name}
                                                                    </div>
                                                                    <div style={{ fontSize: '0.85rem', color: 'var(--text-muted)' }}>
                                                                        {option.description}
                                                                    </div>
                                                                </div>
                                                                <div style={{ fontWeight: 600, color: 'var(--accent)', minWidth: '100px', textAlign: 'right' }}>
                                                                    {option.price === 0 ? 'Inkludiert' : `+ ${option.price.toLocaleString('de-DE')} ‚Ç¨`}
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '2rem' }}>
                                    {project.categories.map(category => {
                                        const customOptions = selectedApartment.customOptions?.[category.id] || [];
                                        
                                        return (
                                            <div key={category.id} style={{ background: 'var(--bg)', padding: '1.5rem', borderRadius: '12px', border: '1px solid var(--border)' }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                                                    <div>
                                                        <h4 style={{ fontSize: '1.1rem', marginBottom: '0.25rem', color: 'var(--primary)' }}>
                                                            {category.name}
                                                        </h4>
                                                        <p style={{ color: 'var(--text-muted)', fontSize: '0.85rem' }}>
                                                            {category.description}
                                                        </p>
                                                    </div>
                                                    <button 
                                                        className="btn btn-small"
                                                        onClick={() => {
                                                            setSelectedCategory(category);
                                                            setShowCustomOptionModal(true);
                                                        }}
                                                    >
                                                        + Option hinzuf√ºgen
                                                    </button>
                                                </div>

                                                {customOptions.length === 0 ? (
                                                    <p style={{ color: 'var(--text-muted)', fontSize: '0.9rem', fontStyle: 'italic', textAlign: 'center', padding: '2rem' }}>
                                                        Keine wohnungsspezifischen Optionen vorhanden
                                                    </p>
                                                ) : (
                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                                        {customOptions.map(option => (
                                                            <div
                                                                key={option.id}
                                                                style={{
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    gap: '1rem',
                                                                    padding: '1rem',
                                                                    background: 'var(--surface)',
                                                                    borderRadius: '8px',
                                                                    border: '2px solid var(--accent)',
                                                                    boxShadow: '0 2px 8px rgba(59, 130, 246, 0.1)'
                                                                }}
                                                            >
                                                                {option.image ? (
                                                                    <img 
                                                                        src={option.image} 
                                                                        alt={option.name}
                                                                        style={{
                                                                            width: '60px',
                                                                            height: '60px',
                                                                            objectFit: 'cover',
                                                                            borderRadius: '6px'
                                                                        }}
                                                                    />
                                                                ) : (
                                                                    <div style={{
                                                                        width: '60px',
                                                                        height: '60px',
                                                                        display: 'flex',
                                                                        alignItems: 'center',
                                                                        justifyContent: 'center',
                                                                        background: 'var(--bg)',
                                                                        borderRadius: '6px',
                                                                        fontSize: '2rem'
                                                                    }}>
                                                                        {option.icon}
                                                                    </div>
                                                                )}
                                                                <div style={{ flex: 1 }}>
                                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.25rem' }}>
                                                                        <div style={{ fontWeight: 600 }}>
                                                                            {option.name}
                                                                        </div>
                                                                        <span style={{ 
                                                                            fontSize: '0.75rem', 
                                                                            padding: '0.125rem 0.5rem', 
                                                                            background: 'var(--accent)', 
                                                                            color: 'white', 
                                                                            borderRadius: '999px',
                                                                            fontWeight: 600
                                                                        }}>
                                                                            NUR DIESE WOHNUNG
                                                                        </span>
                                                                    </div>
                                                                    <div style={{ fontSize: '0.85rem', color: 'var(--text-muted)' }}>
                                                                        {option.description}
                                                                    </div>
                                                                </div>
                                                                <div style={{ fontWeight: 600, color: 'var(--accent)', minWidth: '100px', textAlign: 'right' }}>
                                                                    {option.price === 0 ? 'Inkludiert' : `+ ${option.price.toLocaleString('de-DE')} ‚Ç¨`}
                                                                </div>
                                                                <button
                                                                    className="btn btn-secondary btn-small"
                                                                    onClick={() => handleDeleteCustomOption(category.id, option.id)}
                                                                    style={{ color: 'var(--error)' }}
                                                                >
                                                                    L√∂schen
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                        
                        {showCustomOptionModal && (
                            <CustomOptionModal
                                category={selectedCategory}
                                onClose={() => {
                                    setShowCustomOptionModal(false);
                                    setSelectedCategory(null);
                                }}
                                onSave={(optionData) => handleAddCustomOption(selectedCategory.id, optionData)}
                            />
                        )}
                    </div>
                );
            }

            return (
                <div className="card">
                    <div className="card-header">
                        <h2 className="card-title">Wohnungen</h2>
                        <button className="btn" onClick={onShowApartmentModal}>+ Neue Wohnung</button>
                    </div>
                    <table className="table">
                        <thead>
                            <tr>
                                <th>Nummer</th>
                                <th>Projekt</th>
                                <th>Etage</th>
                                <th>Gr√∂√üe</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.apartments.map(apt => {
                                const project = data.projects.find(p => p.id === apt.projectId);
                                return (
                                    <tr key={apt.id}>
                                        <td><strong>{apt.number}</strong></td>
                                        <td>{project?.name}</td>
                                        <td>{apt.floor}. OG</td>
                                        <td>{apt.size} m¬≤</td>
                                        <td>
                                            <span className={`badge ${apt.status === 'Abgeschlossen' ? 'badge-success' : 'badge-warning'}`}>
                                                {apt.status}
                                            </span>
                                        </td>
                                        <td>
                                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                <button
                                                    className="btn btn-small"
                                                    onClick={() => setSelectedApartment(apt)}
                                                >
                                                    Optionen anpassen
                                                </button>
                                                <button
                                                    className="btn btn-secondary btn-small"
                                                    onClick={() => onDeleteApartment(apt.id)}
                                                    style={{ color: 'var(--error)' }}
                                                >
                                                    L√∂schen
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );
        }

        // Access View Component with Filter and Sorting
        function AccessView({ data, setData, onShowAccessModal }) {
            const [filterProject, setFilterProject] = useState('all');
            const [sortBy, setSortBy] = useState('apartment');

            // L√∂schen-Funktion
            const handleDeleteAccess = (accessId) => {
                if (confirm('M√∂chten Sie diesen Zugangscode wirklich l√∂schen? Der Kunde kann sich dann nicht mehr anmelden.')) {
                    const updatedAccess = data.customerAccess.filter(a => a.id !== accessId);
                    setData({
                        ...data,
                        customerAccess: updatedAccess
                    });
                    alert('‚úÖ Zugangscode wurde gel√∂scht.');
                }
            };

            // Filtern
            let filteredAccess = data.customerAccess.filter(access => {
                const apartment = data.apartments.find(a => a.id === access.apartmentId);
                const project = data.projects.find(p => p.id === apartment?.projectId);
                
                if (filterProject !== 'all' && project?.id !== parseInt(filterProject)) {
                    return false;
                }
                
                return true;
            });

            // Sortieren
            filteredAccess = [...filteredAccess].sort((a, b) => {
                const aptA = data.apartments.find(apt => apt.id === a.apartmentId);
                const aptB = data.apartments.find(apt => apt.id === b.apartmentId);
                
                switch(sortBy) {
                    case 'apartment':
                        return aptA?.number.localeCompare(aptB?.number);
                    case 'apartment-desc':
                        return aptB?.number.localeCompare(aptA?.number);
                    case 'customer':
                        return a.customerName.localeCompare(b.customerName);
                    case 'customer-desc':
                        return b.customerName.localeCompare(a.customerName);
                    default:
                        return 0;
                }
            });

            return (
                <div className="card">
                    <div className="card-header">
                        <h2 className="card-title">Kundenzug√§nge</h2>
                        <button className="btn" onClick={onShowAccessModal}>+ Zugang erstellen</button>
                    </div>
                    
                    {/* Filter und Sortierung */}
                    <div style={{ padding: '1.5rem', background: 'var(--bg)', borderBottom: '1px solid var(--border)' }}>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1rem' }}>
                            <div>
                                <label style={{ display: 'block', fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: 'var(--text-muted)' }}>
                                    Projekt filtern
                                </label>
                                <select 
                                    className="form-input"
                                    value={filterProject}
                                    onChange={(e) => setFilterProject(e.target.value)}
                                >
                                    <option value="all">Alle Projekte</option>
                                    {data.projects.map(project => (
                                        <option key={project.id} value={project.id}>{project.name}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <div>
                                <label style={{ display: 'block', fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: 'var(--text-muted)' }}>
                                    Sortieren nach
                                </label>
                                <select 
                                    className="form-input"
                                    value={sortBy}
                                    onChange={(e) => setSortBy(e.target.value)}
                                >
                                    <option value="apartment">Wohnung (A-Z)</option>
                                    <option value="apartment-desc">Wohnung (Z-A)</option>
                                    <option value="customer">Kunde (A-Z)</option>
                                    <option value="customer-desc">Kunde (Z-A)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style={{ marginTop: '1rem', display: 'flex', gap: '1rem', alignItems: 'center' }}>
                            <span style={{ fontSize: '0.9rem', color: 'var(--text-muted)' }}>
                                {filteredAccess.length} von {data.customerAccess.length} Zugangscodes
                            </span>
                        </div>
                    </div>

                    <table className="table">
                        <thead>
                            <tr>
                                <th>Wohnung</th>
                                <th>Projekt</th>
                                <th>Kunde</th>
                                <th>Zugangscode</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredAccess.map(access => {
                                const apartment = data.apartments.find(a => a.id === access.apartmentId);
                                const project = data.projects.find(p => p.id === apartment?.projectId);
                                return (
                                    <tr key={access.id}>
                                        <td><strong>{apartment?.number}</strong></td>
                                        <td style={{ color: 'var(--text-muted)', fontSize: '0.9rem' }}>{project?.name}</td>
                                        <td>{access.customerName}</td>
                                        <td>
                                            <code style={{ 
                                                padding: '0.25rem 0.5rem', 
                                                background: 'var(--bg)', 
                                                borderRadius: '4px',
                                                fontWeight: 600,
                                                color: 'var(--accent)'
                                            }}>
                                                {access.code}
                                            </code>
                                        </td>
                                        <td>
                                            <button
                                                className="btn btn-small btn-secondary"
                                                onClick={() => handleDeleteAccess(access.id)}
                                                style={{ color: 'var(--error)' }}
                                                title="Zugangscode l√∂schen"
                                            >
                                                üóëÔ∏è L√∂schen
                                            </button>
                                        </td>
                                    </tr>
                                );
                            })}
                            {filteredAccess.length === 0 && (
                                <tr>
                                    <td colSpan="5" style={{ textAlign: 'center', color: 'var(--text-muted)', padding: '3rem' }}>
                                        {data.customerAccess.length === 0 
                                            ? 'Noch keine Kundenzug√§nge erstellt'
                                            : 'Keine Zugangscodes mit den gew√§hlten Filtern gefunden'}
                                    </td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            );
        }

        // Selections View Component with Filters and Analytics
        function SelectionsView({ data, setData, handleGeneratePDF, handleExport }) {
            const [filterProject, setFilterProject] = useState('all');
            const [filterStatus, setFilterStatus] = useState('all');
            const [sortBy, setSortBy] = useState('date-desc');
            const [showAnalytics, setShowAnalytics] = useState(false);
            const [analyticsProject, setAnalyticsProject] = useState(null);

            // Bemusterung zur√ºcksetzen
            const handleResetSelection = (selectionId, apartmentId) => {
                if (confirm('M√∂chten Sie diese Bemusterung wirklich zur√ºcksetzen? Der Kunde kann dann erneut bemuster.')) {
                    // Selection l√∂schen
                    const updatedSelections = data.selections.filter(s => s.id !== selectionId);
                    
                    // Apartment-Status zur√ºcksetzen
                    const updatedApartments = data.apartments.map(apt => 
                        apt.id === apartmentId 
                            ? { ...apt, status: 'Bemusterung offen' }
                            : apt
                    );
                    
                    setData({
                        ...data,
                        selections: updatedSelections,
                        apartments: updatedApartments
                    });
                    
                    alert('‚úÖ Bemusterung wurde zur√ºckgesetzt. Der Kunde kann jetzt neu bemuster.');
                }
            };

            // Filter und sortieren
            let filteredSelections = data.selections.filter(sel => {
                const apartment = data.apartments.find(a => a.id === sel.apartmentId);
                const project = data.projects.find(p => p.id === apartment?.projectId);
                
                if (filterProject !== 'all' && project?.id !== parseInt(filterProject)) {
                    return false;
                }
                
                if (filterStatus !== 'all' && sel.status !== filterStatus) {
                    return false;
                }
                
                return true;
            });

            // Sortierung
            filteredSelections = [...filteredSelections].sort((a, b) => {
                const aptA = data.apartments.find(apt => apt.id === a.apartmentId);
                const aptB = data.apartments.find(apt => apt.id === b.apartmentId);
                
                switch(sortBy) {
                    case 'date-desc':
                        return new Date(b.completedAt) - new Date(a.completedAt);
                    case 'date-asc':
                        return new Date(a.completedAt) - new Date(b.completedAt);
                    case 'apartment':
                        return aptA?.number.localeCompare(aptB?.number);
                    case 'price-desc':
                        const totalA = Object.entries(a.choices).reduce((sum, [catId, optId]) => {
                            const project = data.projects.find(p => p.id === aptA?.projectId);
                            const category = project?.categories.find(c => c.id === parseInt(catId));
                            const option = category?.options.find(o => o.id === optId);
                            return sum + (option?.price || 0);
                        }, 0);
                        const totalB = Object.entries(b.choices).reduce((sum, [catId, optId]) => {
                            const project = data.projects.find(p => p.id === aptB?.projectId);
                            const category = project?.categories.find(c => c.id === parseInt(catId));
                            const option = category?.options.find(o => o.id === optId);
                            return sum + (option?.price || 0);
                        }, 0);
                        return totalB - totalA;
                    case 'price-asc':
                        const totalA2 = Object.entries(a.choices).reduce((sum, [catId, optId]) => {
                            const project = data.projects.find(p => p.id === aptA?.projectId);
                            const category = project?.categories.find(c => c.id === parseInt(catId));
                            const option = category?.options.find(o => o.id === optId);
                            return sum + (option?.price || 0);
                        }, 0);
                        const totalB2 = Object.entries(b.choices).reduce((sum, [catId, optId]) => {
                            const project = data.projects.find(p => p.id === aptB?.projectId);
                            const category = project?.categories.find(c => c.id === parseInt(catId));
                            const option = category?.options.find(o => o.id === optId);
                            return sum + (option?.price || 0);
                        }, 0);
                        return totalA2 - totalB2;
                    default:
                        return 0;
                }
            });

            // Analytics berechnen
            const calculateAnalytics = (projectId) => {
                const project = data.projects.find(p => p.id === projectId);
                const projectSelections = data.selections.filter(sel => {
                    const apartment = data.apartments.find(a => a.id === sel.apartmentId);
                    return apartment?.projectId === projectId;
                });

                const analytics = {
                    total: projectSelections.length,
                    completed: projectSelections.filter(s => s.status === 'Abgeschlossen').length,
                    draft: projectSelections.filter(s => s.status === 'Entwurf').length,
                    categories: {}
                };

                project?.categories.forEach(category => {
                    analytics.categories[category.id] = {
                        name: category.name,
                        options: {}
                    };

                    category.options.forEach(option => {
                        analytics.categories[category.id].options[option.id] = {
                            name: option.name,
                            count: 0,
                            percentage: 0
                        };
                    });
                });

                projectSelections.forEach(sel => {
                    Object.entries(sel.choices).forEach(([catId, optId]) => {
                        const catIdNum = parseInt(catId);
                        if (analytics.categories[catIdNum]?.options[optId]) {
                            analytics.categories[catIdNum].options[optId].count++;
                        }
                    });
                });

                // Prozente berechnen
                Object.values(analytics.categories).forEach(category => {
                    Object.values(category.options).forEach(option => {
                        option.percentage = analytics.total > 0 
                            ? Math.round((option.count / analytics.total) * 100) 
                            : 0;
                    });
                });

                return analytics;
            };

            if (showAnalytics && analyticsProject) {
                const analytics = calculateAnalytics(analyticsProject.id);
                
                return (
                    <div className="card">
                        <div className="card-header">
                            <div>
                                <h2 className="card-title">Auswertung: {analyticsProject.name}</h2>
                                <p style={{ color: 'var(--text-muted)', fontSize: '0.9rem', marginTop: '0.25rem' }}>
                                    {analytics.total} Bemusterungen ({analytics.completed} abgeschlossen, {analytics.draft} Entw√ºrfe)
                                </p>
                            </div>
                            <button className="btn btn-secondary" onClick={() => setShowAnalytics(false)}>
                                ‚Üê Zur√ºck zur Liste
                            </button>
                        </div>

                        <div style={{ padding: '2rem' }}>
                            {Object.entries(analytics.categories).map(([catId, category]) => {
                                const totalSelections = Object.values(category.options).reduce((sum, opt) => sum + opt.count, 0);
                                
                                return (
                                    <div key={catId} style={{ marginBottom: '3rem' }}>
                                        <h3 style={{ fontSize: '1.25rem', marginBottom: '1.5rem', color: 'var(--primary)' }}>
                                            {category.name}
                                        </h3>
                                        
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                            {Object.entries(category.options)
                                                .sort((a, b) => b[1].count - a[1].count)
                                                .map(([optId, option]) => (
                                                    <div key={optId} style={{
                                                        background: 'var(--bg)',
                                                        padding: '1.5rem',
                                                        borderRadius: '12px',
                                                        border: '1px solid var(--border)'
                                                    }}>
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                                            <div>
                                                                <div style={{ fontWeight: 600, fontSize: '1.1rem' }}>
                                                                    {option.name}
                                                                </div>
                                                                <div style={{ color: 'var(--text-muted)', fontSize: '0.9rem', marginTop: '0.25rem' }}>
                                                                    {option.count}x gew√§hlt ({option.percentage}%)
                                                                </div>
                                                            </div>
                                                            <div style={{ 
                                                                fontSize: '2rem', 
                                                                fontWeight: 700, 
                                                                color: 'var(--accent)' 
                                                            }}>
                                                                {option.percentage}%
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Progress Bar */}
                                                        <div style={{
                                                            width: '100%',
                                                            height: '8px',
                                                            background: 'var(--border)',
                                                            borderRadius: '999px',
                                                            overflow: 'hidden'
                                                        }}>
                                                            <div style={{
                                                                width: `${option.percentage}%`,
                                                                height: '100%',
                                                                background: `linear-gradient(90deg, var(--accent) 0%, var(--accent-light) 100%)`,
                                                                transition: 'width 0.5s ease'
                                                            }} />
                                                        </div>
                                                    </div>
                                                ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            }

            return (
                <div className="card">
                    <div className="card-header">
                        <h2 className="card-title">Bemusterungen</h2>
                        <button className="btn btn-accent" onClick={handleExport}>Excel exportieren</button>
                    </div>
                    
                    {/* Filter und Sortierung */}
                    <div style={{ padding: '1.5rem', background: 'var(--bg)', borderBottom: '1px solid var(--border)' }}>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                            <div>
                                <label style={{ display: 'block', fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: 'var(--text-muted)' }}>
                                    Projekt filtern
                                </label>
                                <select 
                                    className="form-input"
                                    value={filterProject}
                                    onChange={(e) => setFilterProject(e.target.value)}
                                >
                                    <option value="all">Alle Projekte</option>
                                    {data.projects.map(project => (
                                        <option key={project.id} value={project.id}>{project.name}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <div>
                                <label style={{ display: 'block', fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: 'var(--text-muted)' }}>
                                    Status filtern
                                </label>
                                <select 
                                    className="form-input"
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                >
                                    <option value="all">Alle Status</option>
                                    <option value="Abgeschlossen">Abgeschlossen</option>
                                    <option value="Entwurf">Vorl√§ufig ausgef√ºllt</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style={{ display: 'block', fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: 'var(--text-muted)' }}>
                                    Sortieren nach
                                </label>
                                <select 
                                    className="form-input"
                                    value={sortBy}
                                    onChange={(e) => setSortBy(e.target.value)}
                                >
                                    <option value="date-desc">Datum (neueste zuerst)</option>
                                    <option value="date-asc">Datum (√§lteste zuerst)</option>
                                    <option value="apartment">Wohnung (A-Z)</option>
                                    <option value="price-desc">Preis (h√∂chster zuerst)</option>
                                    <option value="price-asc">Preis (niedrigster zuerst)</option>
                                </select>
                            </div>

                            <div>
                                <label style={{ display: 'block', fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: 'var(--text-muted)' }}>
                                    Auswertung
                                </label>
                                <select 
                                    className="form-input"
                                    onChange={(e) => {
                                        if (e.target.value) {
                                            const project = data.projects.find(p => p.id === parseInt(e.target.value));
                                            setAnalyticsProject(project);
                                            setShowAnalytics(true);
                                        }
                                    }}
                                    value=""
                                >
                                    <option value="">Projekt ausw√§hlen...</option>
                                    {data.projects.map(project => (
                                        <option key={project.id} value={project.id}>üìä {project.name}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        
                        <div style={{ marginTop: '1rem', display: 'flex', gap: '1rem', alignItems: 'center' }}>
                            <span style={{ fontSize: '0.9rem', color: 'var(--text-muted)' }}>
                                {filteredSelections.length} von {data.selections.length} Bemusterungen
                            </span>
                        </div>
                    </div>

                    <table className="table">
                        <thead>
                            <tr>
                                <th>Wohnung</th>
                                <th>Projekt</th>
                                <th>Datum</th>
                                <th>Gesamtkosten</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredSelections.map(sel => {
                                const apartment = data.apartments.find(a => a.id === sel.apartmentId);
                                const project = data.projects.find(p => p.id === apartment?.projectId);
                                let total = 0;
                                Object.entries(sel.choices).forEach(([catId, optId]) => {
                                    const category = project?.categories.find(c => c.id === parseInt(catId));
                                    const option = category?.options.find(o => o.id === optId);
                                    total += option?.price || 0;
                                });
                                
                                const statusBadge = sel.status === 'Abgeschlossen' 
                                    ? 'badge-success' 
                                    : 'badge-warning';
                                const statusText = sel.status === 'Abgeschlossen' 
                                    ? 'Abgeschlossen' 
                                    : 'Vorl√§ufig ausgef√ºllt';
                                
                                return (
                                    <tr key={sel.id}>
                                        <td><strong>{apartment?.number}</strong></td>
                                        <td style={{ color: 'var(--text-muted)', fontSize: '0.9rem' }}>{project?.name}</td>
                                        <td>{new Date(sel.completedAt).toLocaleDateString('de-DE')}</td>
                                        <td><strong>{total.toLocaleString('de-DE')} ‚Ç¨</strong></td>
                                        <td><span className={`badge ${statusBadge}`}>{statusText}</span></td>
                                        <td>
                                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                <button
                                                    className="btn btn-small"
                                                    onClick={() => {
                                                        handleGeneratePDF(apartment, project, sel.choices, total, sel.status);
                                                    }}
                                                >
                                                    üìÑ PDF
                                                </button>
                                                <button
                                                    className="btn btn-small btn-secondary"
                                                    onClick={() => handleResetSelection(sel.id, sel.apartmentId)}
                                                    style={{ color: 'var(--error)' }}
                                                    title="Bemusterung zur√ºcksetzen"
                                                >
                                                    üîÑ Zur√ºcksetzen
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })}
                            {filteredSelections.length === 0 && (
                                <tr>
                                    <td colSpan="6" style={{ textAlign: 'center', color: 'var(--text-muted)', padding: '3rem' }}>
                                        {data.selections.length === 0 
                                            ? 'Noch keine Bemusterungen vorhanden'
                                            : 'Keine Bemusterungen mit den gew√§hlten Filtern gefunden'}
                                    </td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            );
        }

        // Projects View Component
        function ProjectsView({ data, setData, onShowProjectModal }) {
            const [selectedProject, setSelectedProject] = useState(null);
            const [showCategoryModal, setShowCategoryModal] = useState(false);
            const [showOptionModal, setShowOptionModal] = useState(false);
            const [selectedCategory, setSelectedCategory] = useState(null);

            const handleDeleteProject = (projectId) => {
                if (confirm('M√∂chten Sie dieses Projekt wirklich l√∂schen? Alle zugeh√∂rigen Daten werden gel√∂scht.')) {
                    setData({
                        ...data,
                        projects: data.projects.filter(p => p.id !== projectId),
                        apartments: data.apartments.filter(a => a.projectId !== projectId)
                    });
                }
            };

            const handleArchiveProject = (projectId) => {
                setData({
                    ...data,
                    projects: data.projects.map(p =>
                        p.id === projectId ? { ...p, status: p.status === 'Archiviert' ? 'Aktiv' : 'Archiviert' } : p
                    )
                });
            };

            const handleAddCategory = (categoryData) => {
                const updatedProjects = data.projects.map(p => {
                    if (p.id === selectedProject.id) {
                        return {
                            ...p,
                            categories: [...p.categories, {
                                id: Date.now(),
                                ...categoryData,
                                options: []
                            }]
                        };
                    }
                    return p;
                });
                setData({ ...data, projects: updatedProjects });
                setShowCategoryModal(false);
            };

            const handleAddOption = (optionData) => {
                const updatedProjects = data.projects.map(p => {
                    if (p.id === selectedProject.id) {
                        return {
                            ...p,
                            categories: p.categories.map(c => {
                                if (c.id === selectedCategory.id) {
                                    return {
                                        ...c,
                                        options: [...c.options, {
                                            id: Date.now(),
                                            ...optionData
                                        }]
                                    };
                                }
                                return c;
                            })
                        };
                    }
                    return p;
                });
                setData({ ...data, projects: updatedProjects });
                setShowOptionModal(false);
            };

            const handleDeleteCategory = (projectId, categoryId) => {
                if (confirm('M√∂chten Sie diese Kategorie wirklich l√∂schen?')) {
                    const updatedProjects = data.projects.map(p => {
                        if (p.id === projectId) {
                            return {
                                ...p,
                                categories: p.categories.filter(c => c.id !== categoryId)
                            };
                        }
                        return p;
                    });
                    setData({ ...data, projects: updatedProjects });
                }
            };

            const handleDeleteOption = (projectId, categoryId, optionId) => {
                if (confirm('M√∂chten Sie diese Option wirklich l√∂schen?')) {
                    const updatedProjects = data.projects.map(p => {
                        if (p.id === projectId) {
                            return {
                                ...p,
                                categories: p.categories.map(c => {
                                    if (c.id === categoryId) {
                                        return {
                                            ...c,
                                            options: c.options.filter(o => o.id !== optionId)
                                        };
                                    }
                                    return c;
                                })
                            };
                        }
                        return p;
                    });
                    setData({ ...data, projects: updatedProjects });
                }
            };

            if (selectedProject) {
                return (
                    <>
                        <div className="card">
                            <div className="card-header">
                                <div>
                                    <h2 className="card-title">{selectedProject.name}</h2>
                                    <p style={{ color: 'var(--text-muted)', fontSize: '0.9rem', marginTop: '0.25rem' }}>
                                        {selectedProject.startDate} - {selectedProject.endDate}
                                    </p>
                                </div>
                                <button className="btn btn-secondary" onClick={() => setSelectedProject(null)}>
                                    ‚Üê Zur√ºck zur √úbersicht
                                </button>
                            </div>

                            <div style={{ padding: '1rem 0' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                                    <h3 style={{ fontSize: '1.25rem', color: 'var(--primary)' }}>Bemusterungskategorien</h3>
                                    <button className="btn" onClick={() => setShowCategoryModal(true)}>
                                        + Kategorie hinzuf√ºgen
                                    </button>
                                </div>

                                {selectedProject.categories.length === 0 ? (
                                    <div style={{ textAlign: 'center', padding: '3rem', color: 'var(--text-muted)' }}>
                                        <p>Noch keine Kategorien angelegt.</p>
                                        <p style={{ fontSize: '0.9rem', marginTop: '0.5rem' }}>
                                            F√ºgen Sie Kategorien hinzu, um Ausstattungsoptionen zu definieren.
                                        </p>
                                    </div>
                                ) : (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>
                                        {selectedProject.categories.map(category => (
                                            <div key={category.id} style={{ background: 'var(--bg)', padding: '1.5rem', borderRadius: '8px', border: '1px solid var(--border)' }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '1rem' }}>
                                                    <div>
                                                        <h4 style={{ fontSize: '1.1rem', marginBottom: '0.25rem', color: 'var(--primary)' }}>
                                                            {category.name}
                                                        </h4>
                                                        <p style={{ color: 'var(--text-muted)', fontSize: '0.9rem' }}>
                                                            {category.description}
                                                        </p>
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                        <button
                                                            className="btn btn-small"
                                                            onClick={() => {
                                                                setSelectedCategory(category);
                                                                setShowOptionModal(true);
                                                            }}
                                                        >
                                                            + Option
                                                        </button>
                                                        <button
                                                            className="btn btn-secondary btn-small"
                                                            onClick={() => handleDeleteCategory(selectedProject.id, category.id)}
                                                        >
                                                            L√∂schen
                                                        </button>
                                                    </div>
                                                </div>

                                                {category.options.length === 0 ? (
                                                    <p style={{ color: 'var(--text-muted)', fontSize: '0.85rem', fontStyle: 'italic' }}>
                                                        Keine Optionen vorhanden
                                                    </p>
                                                ) : (
                                                    <div className="options-grid" style={{ marginTop: '1rem' }}>
                                                        {category.options.map(option => (
                                                            <div key={option.id} className="option-card" style={{ cursor: 'default', position: 'relative' }}>
                                                                <button
                                                                    onClick={() => handleDeleteOption(selectedProject.id, category.id, option.id)}
                                                                    style={{
                                                                        position: 'absolute',
                                                                        top: '0.5rem',
                                                                        right: '0.5rem',
                                                                        background: 'var(--error)',
                                                                        color: 'white',
                                                                        border: 'none',
                                                                        borderRadius: '4px',
                                                                        padding: '0.25rem 0.5rem',
                                                                        fontSize: '0.75rem',
                                                                        cursor: 'pointer'
                                                                    }}
                                                                >
                                                                    ‚úï
                                                                </button>
                                                                {option.image ? (
                                                                    <img
                                                                        src={option.image}
                                                                        alt={option.name}
                                                                        style={{
                                                                            width: '100%',
                                                                            height: '180px',
                                                                            objectFit: 'cover',
                                                                            borderRadius: '8px',
                                                                            marginBottom: '1rem'
                                                                        }}
                                                                    />
                                                                ) : (
                                                                    <div className="option-image">{option.icon || 'üì¶'}</div>
                                                                )}
                                                                <div className="option-name">{option.name}</div>
                                                                <div className="option-description">{option.description}</div>
                                                                <div className="option-price">
                                                                    {option.price === 0 ? 'Inkludiert' : `+ ${option.price.toLocaleString('de-DE')} ‚Ç¨`}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>

                        {showCategoryModal && (
                            <CategoryModal
                                onClose={() => setShowCategoryModal(false)}
                                onSave={handleAddCategory}
                            />
                        )}

                        {showOptionModal && (
                            <OptionModal
                                category={selectedCategory}
                                onClose={() => {
                                    setShowOptionModal(false);
                                    setSelectedCategory(null);
                                }}
                                onSave={handleAddOption}
                            />
                        )}
                    </>
                );
            }

            return (
                <div className="card">
                    <div className="card-header">
                        <h2 className="card-title">Projekte</h2>
                        <button className="btn" onClick={onShowProjectModal}>+ Neues Projekt</button>
                    </div>
                    <table className="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Zeitraum</th>
                                <th>Kategorien</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.projects.map(project => (
                                <tr key={project.id}>
                                    <td><strong>{project.name}</strong></td>
                                    <td>
                                        <span className={`badge ${project.status === 'Aktiv' ? 'badge-success' : project.status === 'Archiviert' ? 'badge-warning' : 'badge-primary'}`}>
                                            {project.status}
                                        </span>
                                    </td>
                                    <td>{project.startDate} - {project.endDate}</td>
                                    <td>{project.categories.length} Kategorien</td>
                                    <td>
                                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                                            <button
                                                className="btn btn-small"
                                                onClick={() => setSelectedProject(project)}
                                            >
                                                Bearbeiten
                                            </button>
                                            <button
                                                className="btn btn-secondary btn-small"
                                                onClick={() => handleArchiveProject(project.id)}
                                            >
                                                {project.status === 'Archiviert' ? 'Aktivieren' : 'Archivieren'}
                                            </button>
                                            <button
                                                className="btn btn-secondary btn-small"
                                                onClick={() => handleDeleteProject(project.id)}
                                                style={{ color: 'var(--error)' }}
                                            >
                                                L√∂schen
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }

        // Category Modal Component
        function CategoryModal({ onClose, onSave }) {
            const [formData, setFormData] = useState({
                name: '',
                description: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Neue Kategorie anlegen</h2>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Kategorienname *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="z.B. Bodenbel√§ge"
                                    value={formData.name}
                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Beschreibung *</label>
                                <textarea
                                    className="form-input"
                                    placeholder="z.B. W√§hlen Sie Ihren bevorzugten Bodenbelag"
                                    value={formData.description}
                                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                    rows="3"
                                    required
                                />
                            </div>
                            <div className="modal-actions">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>
                                    Abbrechen
                                </button>
                                <button type="submit" className="btn">
                                    Kategorie erstellen
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Custom Option Modal Component (f√ºr wohnungsspezifische Optionen)
        function CustomOptionModal({ category, onClose, onSave }) {
            const iconOptions = ['üè†', 'üî®', 'üé®', 'üí°', 'üöø', 'üö™', 'ü™ü', 'üîå', 'üå°Ô∏è', 'üîí'];
            const [formData, setFormData] = useState({
                name: '',
                description: '',
                price: '',
                image: '',
                icon: iconOptions[0]
            });

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setFormData({ ...formData, image: reader.result });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({
                    name: formData.name,
                    description: formData.description,
                    price: parseFloat(formData.price) || 0,
                    image: formData.image,
                    icon: formData.icon
                });
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Wohnungsspezifische Option hinzuf√ºgen</h2>
                            <p style={{ color: 'var(--text-muted)', fontSize: '0.9rem', marginTop: '0.5rem' }}>
                                Kategorie: {category.name}
                            </p>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="alert" style={{ background: 'rgba(59, 130, 246, 0.1)', color: 'var(--accent)', border: '1px solid rgba(59, 130, 246, 0.2)' }}>
                                ‚ÑπÔ∏è Diese Option wird nur f√ºr die aktuell ausgew√§hlte Wohnung verf√ºgbar sein.
                            </div>
                            <div className="form-group">
                                <label className="form-label">Name *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="z.B. Parkett Premium"
                                    value={formData.name}
                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Beschreibung *</label>
                                <textarea
                                    className="form-input"
                                    placeholder="z.B. Hochwertiges Echtholz-Parkett in Eiche"
                                    value={formData.description}
                                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                    rows="2"
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Mehrpreis (‚Ç¨) *</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    placeholder="0"
                                    value={formData.price}
                                    onChange={(e) => setFormData({ ...formData, price: e.target.value })}
                                    min="0"
                                    step="0.01"
                                    required
                                />
                                <small style={{ color: 'var(--text-muted)', fontSize: '0.85rem' }}>
                                    0 ‚Ç¨ = Inkludiert
                                </small>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Bild hochladen (optional)</label>
                                <input
                                    type="file"
                                    className="form-input"
                                    accept="image/*"
                                    onChange={handleImageUpload}
                                />
                                {formData.image && (
                                    <img
                                        src={formData.image}
                                        alt="Vorschau"
                                        style={{ marginTop: '0.5rem', maxWidth: '200px', borderRadius: '8px' }}
                                    />
                                )}
                            </div>
                            {!formData.image && (
                                <div className="form-group">
                                    <label className="form-label">Icon w√§hlen (wenn kein Bild)</label>
                                    <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                        {iconOptions.map(icon => (
                                            <button
                                                key={icon}
                                                type="button"
                                                onClick={() => setFormData({ ...formData, icon })}
                                                style={{
                                                    fontSize: '2rem',
                                                    padding: '0.5rem',
                                                    border: formData.icon === icon ? '2px solid var(--accent)' : '2px solid var(--border)',
                                                    borderRadius: '8px',
                                                    background: formData.icon === icon ? 'rgba(59, 130, 246, 0.1)' : 'transparent',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                {icon}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                            <div className="modal-actions">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>
                                    Abbrechen
                                </button>
                                <button type="submit" className="btn">
                                    Option hinzuf√ºgen
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Option Modal Component
        function OptionModal({ category, onClose, onSave }) {
            const [formData, setFormData] = useState({
                name: '',
                description: '',
                price: 0,
                icon: 'üì¶',
                image: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({
                    ...formData,
                    price: parseFloat(formData.price)
                });
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setFormData({ ...formData, image: reader.result });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const iconOptions = ['ü™µ', '‚¨ú', 'üöø', 'üí°', 'üè†', 'üö™', 'ü™ü', 'üé®', 'üîå', 'üì¶', '‚≠ê'];

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Option hinzuf√ºgen: {category.name}</h2>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Optionsname *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="z.B. Eiche Natur"
                                    value={formData.name}
                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Beschreibung *</label>
                                <textarea
                                    className="form-input"
                                    placeholder="z.B. Hochwertiges Parkettlaminat in nat√ºrlicher Eiche"
                                    value={formData.description}
                                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                    rows="2"
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Mehrpreis (‚Ç¨) *</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    placeholder="0"
                                    value={formData.price}
                                    onChange={(e) => setFormData({ ...formData, price: e.target.value })}
                                    min="0"
                                    step="0.01"
                                    required
                                />
                                <small style={{ color: 'var(--text-muted)', fontSize: '0.85rem' }}>
                                    0 ‚Ç¨ = Basisausstattung (inkludiert)
                                </small>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Bild hochladen (optional)</label>
                                <input
                                    type="file"
                                    className="form-input"
                                    accept="image/*"
                                    onChange={handleImageUpload}
                                />
                                {formData.image && (
                                    <img
                                        src={formData.image}
                                        alt="Vorschau"
                                        style={{ marginTop: '0.5rem', maxWidth: '200px', borderRadius: '8px' }}
                                    />
                                )}
                            </div>
                            {!formData.image && (
                                <div className="form-group">
                                    <label className="form-label">Icon w√§hlen (wenn kein Bild)</label>
                                    <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                        {iconOptions.map(icon => (
                                            <button
                                                key={icon}
                                                type="button"
                                                onClick={() => setFormData({ ...formData, icon })}
                                                style={{
                                                    fontSize: '2rem',
                                                    padding: '0.5rem',
                                                    border: formData.icon === icon ? '2px solid var(--accent)' : '2px solid var(--border)',
                                                    borderRadius: '8px',
                                                    background: formData.icon === icon ? 'rgba(212, 175, 55, 0.1)' : 'transparent',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                {icon}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                            <div className="modal-actions">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>
                                    Abbrechen
                                </button>
                                <button type="submit" className="btn">
                                    Option hinzuf√ºgen
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Access Modal Component
        function AccessModal({ apartments, existingAccess, onClose, onSave }) {
            // Filter out apartments that already have access codes
            const availableApartments = apartments.filter(apt => 
                !existingAccess.some(access => access.apartmentId === apt.id)
            );

            const [formData, setFormData] = useState({
                apartmentId: availableApartments[0]?.id || '',
                customerName: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({
                    ...formData,
                    apartmentId: parseInt(formData.apartmentId)
                });
            };

            if (availableApartments.length === 0) {
                return (
                    <div className="modal-overlay" onClick={onClose}>
                        <div className="modal" onClick={(e) => e.stopPropagation()}>
                            <div className="modal-header">
                                <h2 className="modal-title">Kundenzugang erstellen</h2>
                            </div>
                            <div className="alert" style={{ background: 'rgba(245, 158, 11, 0.1)', color: 'var(--warning)', border: '1px solid rgba(245, 158, 11, 0.2)' }}>
                                ‚ö†Ô∏è Alle Wohnungen haben bereits einen Zugangscode. Es sind keine weiteren Wohnungen verf√ºgbar.
                            </div>
                            <div className="modal-actions">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>
                                    Schlie√üen
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Kundenzugang erstellen</h2>
                            <p style={{ color: 'var(--text-muted)', fontSize: '0.9rem', marginTop: '0.5rem' }}>
                                {availableApartments.length} Wohnung{availableApartments.length !== 1 ? 'en' : ''} ohne Zugangscode verf√ºgbar
                            </p>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Wohnung *</label>
                                <select
                                    className="form-input"
                                    value={formData.apartmentId}
                                    onChange={(e) => setFormData({ ...formData, apartmentId: e.target.value })}
                                    required
                                >
                                    {availableApartments.map(apt => (
                                        <option key={apt.id} value={apt.id}>
                                            Wohnung {apt.number}
                                        </option>
                                    ))}
                                </select>
                                <small style={{ color: 'var(--text-muted)', fontSize: '0.85rem' }}>
                                    Nur Wohnungen ohne bestehenden Zugangscode
                                </small>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Name des Kunden *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="z.B. Familie M√ºller"
                                    value={formData.customerName}
                                    onChange={(e) => setFormData({ ...formData, customerName: e.target.value })}
                                    required
                                />
                                <small style={{ color: 'var(--text-muted)', fontSize: '0.85rem' }}>
                                    Dieser Name wird dem Kunden auf der Bemusterungsseite angezeigt
                                </small>
                            </div>
                            <div className="alert" style={{ background: 'rgba(107, 114, 128, 0.1)', color: 'var(--primary)', border: '1px solid rgba(107, 114, 128, 0.2)' }}>
                                ‚ÑπÔ∏è Ein Zugangscode wird automatisch generiert und kann dem Kunden mitgeteilt werden.
                            </div>
                            <div className="modal-actions">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>
                                    Abbrechen
                                </button>
                                <button type="submit" className="btn">
                                    Zugang erstellen
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Customer Wizard
        function CustomerWizard({ user, data, setData, onLogout }) {
            const apartment = data.apartments.find(a => a.id === user.apartmentId);
            const project = data.projects.find(p => p.id === apartment?.projectId);
            const customerAccess = data.customerAccess.find(ca => ca.apartmentId === user.apartmentId);
            const existingSelection = data.selections.find(s => s.apartmentId === user.apartmentId);

            const [currentStep, setCurrentStep] = useState(-1); // Start with welcome screen
            const [selections, setSelections] = useState(existingSelection?.choices || {});
            const [completed, setCompleted] = useState(existingSelection?.status === 'Abgeschlossen');
            const [lightboxImage, setLightboxImage] = useState(null);

            if (!project || !apartment) {
                return <div>Fehler: Projekt oder Wohnung nicht gefunden</div>;
            }

            if (completed) {
                const totalPrice = Object.entries(selections).reduce((sum, [catId, optId]) => {
                    const category = project.categories.find(c => c.id === parseInt(catId));
                    const option = category?.options.find(o => o.id === optId);
                    return sum + (option?.price || 0);
                }, 0);

                return (
                    <div className="app-container">
                        <div className="header">
                            <div className="header-content">
                                <div className="logo">
                                    {project.logo ? (
                                        <img 
                                            src={project.logo} 
                                            alt={project.name} 
                                            style={{ height: '40px', width: 'auto', maxWidth: '200px', objectFit: 'contain' }}
                                        />
                                    ) : (
                                        <>
                                            <div className="logo-icon">B</div>
                                            Bemusterungstool
                                        </>
                                    )}
                                </div>
                                <div className="user-info">
                                    <span>Wohnung {apartment.number}</span>
                                    <button className="btn-logout" onClick={onLogout}>Abmelden</button>
                                </div>
                            </div>
                        </div>
                        <div className="main-content">
                            <div className="wizard-container">
                                <div className="card completion-container">
                                    <div className="completion-icon">‚úì</div>
                                    <h1 className="completion-title">Bemusterung abgeschlossen!</h1>
                                    <p className="completion-message">
                                        Vielen Dank f√ºr Ihre Auswahl. Wir haben Ihre Bemusterung erfolgreich gespeichert.
                                        Ihre Best√§tigung wurde als PDF heruntergeladen.
                                    </p>
                                    <div className="wizard-summary">
                                        <h3 style={{ marginBottom: '1rem', color: 'var(--primary)' }}>Ihre Auswahl</h3>
                                        {Object.entries(selections).map(([catId, optId]) => {
                                            const category = project.categories.find(c => c.id === parseInt(catId));
                                            const option = category?.options.find(o => o.id === optId);
                                            return (
                                                <div key={catId} className="summary-item" style={{ alignItems: 'flex-start' }}>
                                                    {option?.image && (
                                                        <div style={{ position: 'relative', marginRight: '1rem' }}>
                                                            <img
                                                                src={option.image}
                                                                alt={option.name}
                                                                className="option-image-clickable"
                                                                style={{
                                                                    width: '80px',
                                                                    height: '80px',
                                                                    objectFit: 'cover',
                                                                    borderRadius: '8px',
                                                                    cursor: 'zoom-in'
                                                                }}
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    setLightboxImage(option.image);
                                                                }}
                                                            />
                                                            <div
                                                                style={{
                                                                    position: 'absolute',
                                                                    top: '4px',
                                                                    right: '4px',
                                                                    background: 'rgba(0, 0, 0, 0.6)',
                                                                    color: 'white',
                                                                    borderRadius: '50%',
                                                                    width: '24px',
                                                                    height: '24px',
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    justifyContent: 'center',
                                                                    fontSize: '0.9rem',
                                                                    pointerEvents: 'none',
                                                                    backdropFilter: 'blur(4px)'
                                                                }}
                                                            >
                                                                üîç
                                                            </div>
                                                        </div>
                                                    )}
                                                    <div style={{ flex: 1 }}>
                                                        <span>{category?.name}</span>
                                                        <div style={{ marginTop: '0.25rem' }}>
                                                            <strong>{option?.name}</strong> ({option?.price.toLocaleString('de-DE')} ‚Ç¨)
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        <div className="summary-item">
                                            <span>Gesamtkosten</span>
                                            <span>{totalPrice.toLocaleString('de-DE')} ‚Ç¨</span>
                                        </div>
                                    </div>
                                    <p style={{ color: 'var(--text-muted)', fontSize: '0.9rem' }}>
                                        Bei Fragen wenden Sie sich bitte an unser Team.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <footer className="app-footer">
                            <div className="footer-content">
                                <a 
                                    href="https://www.g-s-wohnbau.de/datenschutz" 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="footer-link"
                                >
                                    Datenschutz
                                </a>
                                <span className="footer-divider">‚Ä¢</span>
                                <a 
                                    href="https://www.g-s-wohnbau.de/impressum" 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="footer-link"
                                >
                                    Impressum
                                </a>
                                <span className="footer-divider">‚Ä¢</span>
                                <span style={{ fontSize: '0.85rem', opacity: 0.7 }}>
                                    ¬© 2026 G+S Gruppe
                                </span>
                            </div>
                        </footer>
                        {lightboxImage && <Lightbox imageUrl={lightboxImage} onClose={() => setLightboxImage(null)} />}
                    </div>
                );
            }

            // Filter categories and add apartment-specific options
            const availableCategories = project.categories.map(category => {
                const hiddenOptions = apartment.hiddenOptions?.[category.id] || [];
                const customCategoryOptions = apartment.customOptions?.[category.id] || [];
                
                // Combine regular options (not hidden) with custom options
                const regularOptions = category.options.filter(opt => !hiddenOptions.includes(opt.id));
                const allOptions = [...regularOptions, ...customCategoryOptions];
                
                return {
                    ...category,
                    options: allOptions
                };
            }).filter(category => category.options.length > 0);
            
            const categories = availableCategories;
            const isReview = currentStep === categories.length;

            const handleSelectOption = (optionId) => {
                setSelections({ ...selections, [categories[currentStep].id]: optionId });
            };

            const handleNext = () => {
                if (currentStep < categories.length) {
                    setCurrentStep(currentStep + 1);
                }
            };

            const handleBack = () => {
                if (currentStep > 0) {
                    setCurrentStep(currentStep - 1);
                } else if (currentStep === 0) {
                    setCurrentStep(-1); // Back to welcome screen
                }
            };

            const handleSaveDraft = () => {
                const existingDraft = data.selections.find(s => s.apartmentId === user.apartmentId && s.status === 'Entwurf');
                
                if (existingDraft) {
                    // Update existing draft
                    setData({
                        ...data,
                        selections: data.selections.map(s =>
                            s.id === existingDraft.id
                                ? { ...s, choices: selections, completedAt: new Date().toISOString() }
                                : s
                        )
                    });
                } else {
                    // Create new draft
                    const newDraft = {
                        id: Date.now(),
                        apartmentId: user.apartmentId,
                        choices: selections,
                        status: 'Entwurf',
                        completedAt: new Date().toISOString()
                    };
                    setData({
                        ...data,
                        selections: [...data.selections, newDraft],
                        apartments: data.apartments.map(a =>
                            a.id === user.apartmentId ? { ...a, status: 'Vorl√§ufig ausgef√ºllt' } : a
                        )
                    });
                }
                
                alert('‚úÖ Entwurf gespeichert! Sie k√∂nnen jederzeit zur√ºckkehren und Ihre Auswahl bearbeiten.');
            };

            const handleComplete = () => {
                const existingDraft = data.selections.find(s => s.apartmentId === user.apartmentId && s.status === 'Entwurf');
                
                const newSelection = {
                    id: existingDraft?.id || Date.now(),
                    apartmentId: user.apartmentId,
                    choices: selections,
                    status: 'Abgeschlossen',
                    completedAt: new Date().toISOString()
                };
                
                if (existingDraft) {
                    // Update existing draft to completed
                    setData({
                        ...data,
                        selections: data.selections.map(s =>
                            s.id === existingDraft.id ? newSelection : s
                        ),
                        apartments: data.apartments.map(a =>
                            a.id === user.apartmentId ? { ...a, status: 'Abgeschlossen' } : a
                        )
                    });
                } else {
                    // Create new completed selection
                    setData({
                        ...data,
                        selections: [...data.selections, newSelection],
                        apartments: data.apartments.map(a =>
                            a.id === user.apartmentId ? { ...a, status: 'Abgeschlossen' } : a
                        )
                    });
                }
                
                setCompleted(true);

                // Generate and download PDF
                setTimeout(() => {
                    generatePDF(apartment, project, selections, totalPrice);
                }, 500);
            };

            const generatePDF = (apartment, project, selections, totalPrice) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header with gray design
                doc.setFillColor(107, 114, 128); // Gray instead of blue
                doc.rect(0, 0, 210, 45, 'F');
                
                // G+S Logo area (placeholder)
                doc.setFillColor(255, 255, 255);
                doc.rect(15, 10, 25, 25, 'F');
                doc.setFontSize(16);
                doc.setTextColor(107, 114, 128);
                doc.setFont('helvetica', 'bold');
                doc.text('G+S', 20, 26);
                
                // Title
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('Bemusterungsbest√§tigung', 50, 28);

                // Project & Apartment Info
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`Projekt: ${project.name}`, 20, 60);
                doc.text(`Wohnung: ${apartment.number}`, 20, 67);
                doc.text(`Gr√∂√üe: ${apartment.size} m¬≤`, 20, 74);
                doc.text(`Datum: ${new Date().toLocaleDateString('de-DE')}`, 150, 67);

                // Status badge (always Abgeschlossen for customer PDFs)
                doc.setFillColor(5, 150, 105); // Green
                doc.roundedRect(150, 72, 40, 8, 2, 2, 'F');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('ABGESCHLOSSEN', 170, 77.5, { align: 'center' });

                // Line separator
                doc.setDrawColor(107, 114, 128);
                doc.setLineWidth(0.5);
                doc.line(20, 85, 190, 85);

                // Selections
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Ihre Auswahl:', 20, 95);
                
                let yPos = 105;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');

                Object.entries(selections).forEach(([catId, optId]) => {
                    const category = project.categories.find(c => c.id === parseInt(catId));
                    const option = category?.options.find(o => o.id === optId);
                    
                    if (category && option) {
                        // Category background
                        doc.setFillColor(250, 250, 250);
                        doc.rect(20, yPos - 5, 170, 16, 'F');
                        
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text(category.name, 25, yPos);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(60, 60, 60);
                        doc.text(option.name, 25, yPos + 7);
                        
                        // Price
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(107, 114, 128);
                        const priceText = option.price === 0 ? 'Inkl.' : `+ ${option.price.toLocaleString('de-DE')} ‚Ç¨`;
                        doc.text(priceText, 185, yPos + 3, { align: 'right' });
                        
                        yPos += 20;
                    }
                });

                // Total box
                yPos += 5;
                doc.setFillColor(107, 114, 128);
                doc.rect(20, yPos, 170, 18, 'F');
                doc.setFontSize(13);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('Gesamte Mehrkosten:', 25, yPos + 11);
                doc.text(`${totalPrice.toLocaleString('de-DE')} ‚Ç¨`, 185, yPos + 11, { align: 'right' });

                // Footer
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(107, 114, 128);
                doc.text('Diese Auswahl ist verbindlich und kann nicht mehr ge√§ndert werden.', 20, 280);
                doc.text('G+S Gruppe ‚Ä¢ Projektentwicklung seit √ºber 60 Jahren ‚Ä¢ www.g-s-wohnbau.de', 20, 290);

                // Download
                doc.save(`Bemusterung_${apartment.number}_Final_${new Date().toLocaleDateString('de-DE').replace(/\./g, '-')}.pdf`);
            };

            const totalPrice = Object.entries(selections).reduce((sum, [catId, optId]) => {
                const category = project.categories.find(c => c.id === parseInt(catId));
                const option = category?.options.find(o => o.id === optId);
                return sum + (option?.price || 0);
            }, 0);

            return (
                <div className="app-container">
                    <div className="header">
                        <div className="header-content">
                            <div className="logo">
                                {project.logo ? (
                                    <img 
                                        src={project.logo} 
                                        alt={project.name} 
                                        style={{ height: '40px', width: 'auto', maxWidth: '200px', objectFit: 'contain' }}
                                    />
                                ) : (
                                    <>
                                        <div className="logo-icon">B</div>
                                        Bemusterungstool
                                    </>
                                )}
                            </div>
                            <div className="user-info">
                                <span>
                                    {customerAccess?.customerName && (
                                        <><strong>{customerAccess.customerName}</strong> ‚Ä¢ </>
                                    )}
                                    Wohnung {apartment.number} ‚Ä¢ {project.name}
                                </span>
                                <button className="btn-logout" onClick={onLogout}>Abmelden</button>
                            </div>
                        </div>
                    </div>

                    <div className="main-content">
                        <div className="wizard-container">
                            {currentStep === -1 ? (
                                // Welcome Screen
                                <div className="wizard-content" style={{ textAlign: 'center', padding: '3rem' }}>
                                    <h2 className="wizard-category-title" style={{ fontSize: '2.5rem', marginBottom: '1.5rem' }}>
                                        {customerAccess?.customerName ? `Willkommen ${customerAccess.customerName}` : 'Willkommen zur Bemusterung'}
                                    </h2>
                                    <div style={{ 
                                        fontSize: '1.1rem', 
                                        lineHeight: '1.8', 
                                        color: 'var(--text)', 
                                        marginBottom: '2rem',
                                        maxWidth: '700px',
                                        margin: '0 auto 2rem'
                                    }}>
                                        {project.welcomeText || 'Herzlich willkommen zur Bemusterung Ihrer neuen Wohnung! Auf den folgenden Seiten k√∂nnen Sie Ihre pers√∂nlichen Ausstattungsw√ºnsche ausw√§hlen. Nehmen Sie sich Zeit und treffen Sie Ihre Auswahl in Ruhe.'}
                                    </div>
                                    {project.welcomeImage && (
                                        <div style={{ 
                                            marginBottom: '2rem',
                                            borderRadius: '12px',
                                            overflow: 'hidden',
                                            maxWidth: '800px',
                                            margin: '0 auto 2rem',
                                            boxShadow: 'var(--shadow-lg)'
                                        }}>
                                            <img 
                                                src={project.welcomeImage} 
                                                alt={project.name}
                                                style={{ 
                                                    width: '100%', 
                                                    maxHeight: '400px', 
                                                    objectFit: 'cover'
                                                }}
                                            />
                                        </div>
                                    )}
                                    <div style={{ 
                                        background: 'var(--bg)', 
                                        padding: '1.5rem', 
                                        borderRadius: '8px',
                                        marginBottom: '2rem',
                                        maxWidth: '600px',
                                        margin: '0 auto 2rem'
                                    }}>
                                        <div style={{ fontWeight: 600, marginBottom: '0.5rem' }}>Ihre Wohnung:</div>
                                        <div style={{ fontSize: '1.1rem', color: 'var(--primary)' }}>
                                            {apartment.number} ‚Ä¢ {apartment.size} m¬≤ ‚Ä¢ {apartment.floor}. OG
                                        </div>
                                        <div style={{ marginTop: '1rem', color: 'var(--text-muted)', fontSize: '0.9rem' }}>
                                            Projekt: {project.name}
                                        </div>
                                    </div>
                                    <button 
                                        className="btn" 
                                        onClick={() => setCurrentStep(0)}
                                        style={{ fontSize: '1.1rem', padding: '1rem 2.5rem' }}
                                    >
                                        Zur Bemusterung starten
                                    </button>
                                </div>
                            ) : (
                                <>
                            <div className="wizard-progress">
                                <div className="wizard-steps">
                                    {categories.map((cat, idx) => (
                                        <div key={cat.id} className={`wizard-step ${idx === currentStep ? 'active' : ''} ${idx < currentStep ? 'completed' : ''}`}>
                                            <div className="wizard-step-number">{idx + 1}</div>
                                            <div className="wizard-step-label">{cat.name}</div>
                                        </div>
                                    ))}
                                    <div className={`wizard-step ${isReview ? 'active' : ''}`}>
                                        <div className="wizard-step-number">‚úì</div>
                                        <div className="wizard-step-label">√úbersicht</div>
                                    </div>
                                </div>
                            </div>

                            <div className="wizard-content">
                                {!isReview ? (
                                    <>
                                        <h2 className="wizard-category-title">{categories[currentStep].name}</h2>
                                        <p className="wizard-category-desc">{categories[currentStep].description}</p>

                                        <div className="options-grid">
                                            {categories[currentStep].options.map(option => {
                                                return (
                                                    <div
                                                        key={option.id}
                                                        className={`option-card ${selections[categories[currentStep].id] === option.id ? 'selected' : ''}`}
                                                        onClick={() => handleSelectOption(option.id)}
                                                    >
                                                        {option.image ? (
                                                            <div style={{ position: 'relative' }}>
                                                                <img
                                                                    src={option.image}
                                                                    alt={option.name}
                                                                    className="option-image-clickable"
                                                                    style={{
                                                                        width: '100%',
                                                                        height: '200px',
                                                                        objectFit: 'cover',
                                                                        borderRadius: '12px',
                                                                        marginBottom: '1rem'
                                                                    }}
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        setLightboxImage(option.image);
                                                                    }}
                                                                />
                                                                <div
                                                                    style={{
                                                                        position: 'absolute',
                                                                        top: '8px',
                                                                        right: '8px',
                                                                        background: 'rgba(0, 0, 0, 0.6)',
                                                                        color: 'white',
                                                                        borderRadius: '50%',
                                                                        width: '32px',
                                                                        height: '32px',
                                                                        display: 'flex',
                                                                        alignItems: 'center',
                                                                        justifyContent: 'center',
                                                                        fontSize: '1.2rem',
                                                                        pointerEvents: 'none',
                                                                        backdropFilter: 'blur(4px)'
                                                                    }}
                                                                >
                                                                    üîç
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <div className="option-image">{option.icon}</div>
                                                        )}
                                                        <div className="option-name">{option.name}</div>
                                                        <div className="option-description">{option.description}</div>
                                                        <div className="option-price">
                                                            {option.price === 0 ? 'Inkludiert' : `+ ${option.price.toLocaleString('de-DE')} ‚Ç¨`}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>

                                        <div className="wizard-actions">
                                            <button className="btn btn-secondary" onClick={handleBack} disabled={currentStep === 0}>
                                                ‚Üê Zur√ºck
                                            </button>
                                            <button
                                                className="btn"
                                                onClick={handleNext}
                                                disabled={!selections[categories[currentStep].id]}
                                            >
                                                Weiter ‚Üí
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <h2 className="wizard-category-title">Zusammenfassung Ihrer Auswahl</h2>
                                        <p className="wizard-category-desc">Bitte √ºberpr√ºfen Sie Ihre Auswahl vor der verbindlichen Best√§tigung</p>

                                        <div className="price-display">
                                            <div className="price-label">Gesamte Mehrkosten</div>
                                            <div className="price-amount">{totalPrice.toLocaleString('de-DE')} ‚Ç¨</div>
                                        </div>

                                        <div className="wizard-summary">
                                            {Object.entries(selections).map(([catId, optId]) => {
                                                const category = project.categories.find(c => c.id === parseInt(catId));
                                                const option = category?.options.find(o => o.id === optId);
                                                return (
                                                    <div key={catId} className="summary-item" style={{ alignItems: 'flex-start' }}>
                                                        {option?.image && (
                                                            <div style={{ position: 'relative', marginRight: '1rem' }}>
                                                                <img
                                                                    src={option.image}
                                                                    alt={option.name}
                                                                    className="option-image-clickable"
                                                                    style={{
                                                                        width: '80px',
                                                                        height: '80px',
                                                                        objectFit: 'cover',
                                                                        borderRadius: '8px',
                                                                        cursor: 'zoom-in'
                                                                    }}
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        setLightboxImage(option.image);
                                                                    }}
                                                                />
                                                                <div
                                                                    style={{
                                                                        position: 'absolute',
                                                                        top: '4px',
                                                                        right: '4px',
                                                                        background: 'rgba(0, 0, 0, 0.6)',
                                                                        color: 'white',
                                                                        borderRadius: '50%',
                                                                        width: '24px',
                                                                        height: '24px',
                                                                        display: 'flex',
                                                                        alignItems: 'center',
                                                                        justifyContent: 'center',
                                                                        fontSize: '0.9rem',
                                                                        pointerEvents: 'none',
                                                                        backdropFilter: 'blur(4px)'
                                                                    }}
                                                                >
                                                                    üîç
                                                                </div>
                                                            </div>
                                                        )}
                                                        <div style={{ flex: 1 }}>
                                                            <div style={{ fontWeight: 600, marginBottom: '0.25rem' }}>{category?.name}</div>
                                                            <div style={{ fontSize: '0.9rem', color: 'var(--text-muted)' }}>{option?.name}</div>
                                                        </div>
                                                        <div style={{ fontWeight: 600, color: 'var(--accent)', whiteSpace: 'nowrap' }}>
                                                            {option?.price === 0 ? 'Inkl.' : `${option?.price.toLocaleString('de-DE')} ‚Ç¨`}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                            <div className="summary-item">
                                                <span>Gesamtkosten</span>
                                                <span>{totalPrice.toLocaleString('de-DE')} ‚Ç¨</span>
                                            </div>
                                        </div>

                                        <div className="alert" style={{ background: 'rgba(245, 158, 11, 0.1)', color: 'var(--warning)', border: '1px solid rgba(245, 158, 11, 0.2)' }}>
                                            ‚ö†Ô∏è <strong>Hinweis:</strong> Nach der verbindlichen Best√§tigung k√∂nnen keine √Ñnderungen mehr vorgenommen werden.
                                        </div>

                                        <div className="wizard-actions" style={{ display: 'flex', gap: '0.75rem', justifyContent: 'space-between' }}>
                                            <button className="btn btn-secondary" onClick={handleBack}>
                                                ‚Üê Zur√ºck
                                            </button>
                                            <div style={{ display: 'flex', gap: '0.75rem' }}>
                                                <button className="btn btn-secondary" onClick={handleSaveDraft}>
                                                    üíæ Entwurf speichern
                                                </button>
                                                <button className="btn btn-accent" onClick={handleComplete}>
                                                    ‚úì Verbindlich best√§tigen
                                                </button>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                            </>
                            )}
                        </div>
                    </div>
                    <footer className="app-footer">
                        <div className="footer-content">
                            <a 
                                href="https://www.g-s-wohnbau.de/datenschutz" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="footer-link"
                            >
                                Datenschutz
                            </a>
                            <span className="footer-divider">‚Ä¢</span>
                            <a 
                                href="https://www.g-s-wohnbau.de/impressum" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="footer-link"
                            >
                                Impressum
                            </a>
                            <span className="footer-divider">‚Ä¢</span>
                            <span style={{ fontSize: '0.85rem', opacity: 0.7 }}>
                                ¬© 2026 G+S Gruppe
                            </span>
                        </div>
                    </footer>
                    {lightboxImage && <Lightbox imageUrl={lightboxImage} onClose={() => setLightboxImage(null)} />}
                </div>
            );
        }

        // Lightbox Component
        function Lightbox({ imageUrl, onClose }) {
            React.useEffect(() => {
                const handleEscape = (e) => {
                    if (e.key === 'Escape') onClose();
                };
                document.addEventListener('keydown', handleEscape);
                return () => document.removeEventListener('keydown', handleEscape);
            }, [onClose]);

            return (
                <div className="lightbox-overlay" onClick={onClose}>
                    <div className="lightbox-content" onClick={(e) => e.stopPropagation()}>
                        <button className="lightbox-close" onClick={onClose}>√ó</button>
                        <img src={imageUrl} alt="Vergr√∂√üerte Ansicht" className="lightbox-image" />
                    </div>
                </div>
            );
        }

        // Render App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>